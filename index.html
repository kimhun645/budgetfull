<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดทำงบประมาณประจำปี</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the body, using Sarabun font and a light grey background */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
        }
        /* Transition effects for main navigation cards on hover */
        .main-nav-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .main-nav-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Active state for main navigation cards */
        .main-nav-card.active {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4), 0 4px 6px -2px rgba(79, 70, 229, 0.1);
        }
        /* Subtitle color for active main navigation cards */
        .main-nav-card.active .nav-card-subtitle {
            color: #e0e7ff; /* Indigo 200 */
        }
        /* Transition effects for sub-navigation buttons */
        .sub-nav-button {
            transition: color 0.2s ease, border-color 0.2s ease;
        }
        /* Active state for sub-navigation buttons */
        .sub-nav-button.active {
            color: #6d28d9; /* Violet 700 */
            border-color: #6d28d9;
        }
        /* Transition for modal opacity */
        .modal { transition: opacity 0.25s ease; }
        /* Transition for saving indicator opacity */
        .saving-indicator { transition: opacity 0.5s ease; }
        /* Hide spin buttons for number inputs in WebKit browsers */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Hide spin buttons for number inputs in Firefox */
        input[type=number] { -moz-appearance: textfield; }
        /* Styling for flat input fields */
        .flat-input {
            background-color: transparent;
            border: none;
            outline: none;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        /* Text alignment for flat inputs */
        .flat-input.text-right { text-align: right; }
        .flat-input.text-left { text-align: left; }
        /* Hover and focus states for flat inputs */
        .flat-input:focus, .flat-input:hover {
            background-color: rgba(0,0,0,0.05);
        }
        /* Styling for elements with tooltips */
        .has-tooltip {
            cursor: help;
            border-bottom: 1px dotted #9ca3af;
        }
        /* Styles for draggable rows */
        .budget-row {
            cursor: grab;
        }
        .budget-row.dragging {
            opacity: 0.4;
        }
        .budget-row.drag-over {
            border-top: 2px solid #4f46e5; /* Indigo 600 */
        }
        /* Print-specific styles */
        @media print {
            /* Hide all elements by default when printing */
            body * {
                visibility: hidden;
            }
            /* Make the budget view and its children visible when printing */
            #view-budget, #view-budget * {
                visibility: visible;
            }
            /* Position the budget view for printing */
            #view-budget {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            /* Hide elements with 'no-print' class when printing */
            .no-print {
                display: none;
            }
            /* Remove borders and background from flat inputs when printing */
            .flat-input {
                border: none !important;
                background-color: transparent !important;
            }
            /* Ensure background colors are printed for specific Tailwind classes */
            .bg-blue-600 {
                background-color: #2563eb !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
             .bg-gray-200 {
                background-color: #e5e7eb !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Main Header Section -->
        <header class="bg-white rounded-xl shadow-md p-6 mb-8 no-print">
            <div class="text-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-600">ระบบจัดทำงบประมาณประจำปี</h1>
                <!-- Removed: <p class="text-gray-500 mt-2">ระบบจัดการและคำนวณงบประมาณอย่างมีประสิทธิภาพ</p> -->
            </div>
            <div class="flex flex-wrap items-center justify-center gap-3">
                <!-- Save All Data Button -->
                <button onclick="saveAllData()" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a1 1 0 011 1v3a1 1 0 11-2 0V8h-4v3.586l-1.293-1.293zM9 4a1 1 0 012 0v2.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414L9 6.586V4z"/></svg>
                    บันทึกทั้งหมด
                </button>
                <!-- Export Budget to Excel Button -->
                <button id="export-excel-btn" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
                    ส่งออกงบประมาณ
                </button>
                <!-- Import Employee Data Button -->
                <button id="import-config-btn" class="flex items-center gap-2 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 8a1 1 0 011-1h2a1 1 0 110 2H8a1 1 0 01-1-1zm3-4a1 1 0 10-2 0v1a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                    นำเข้าพนักงาน
                </button>
                <!-- Reset System Data Button -->
                <button id="reset-data-btn" class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1H4a1 1 0 000 2h1v9a2 2 0 002 2h6a2 2 0 002-2V6h1a1 1 0 100-2h-4V3a1 1 0 00-1-1H9zm7 2h-2v10a1 1 0 01-1 1H7a1 1 0 01-1-1V4H4a1 1 0 110-2h12a1 1 0 110 2z" clip-rule="evenodd" /></svg>
                    รีเซ็ตระบบ
                </button>
            </div>
        </header>
        
        <!-- Main Navigation Section -->
        <nav class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8 no-print">
            <!-- Budget Navigation Card -->
            <div id="nav-budget" class="main-nav-card bg-white rounded-xl shadow-sm p-4 text-center cursor-pointer">
                <div class="bg-indigo-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-2 h-6 w-6 text-indigo-600">
                        <line x1="18" x2="18" y1="20" y2="10"/>
                        <line x1="12" x2="12" y1="20" y2="4"/>
                        <line x1="6" x2="6" y1="20" y2="14"/>
                    </svg>
                </div>
                <h3 class="font-bold">งบประมาณ</h3>
                <p class="nav-card-subtitle text-xs text-gray-500">จัดการรายการงบประมาณรายปี</p>
            </div>
            <!-- Employee Configuration Navigation Card -->
             <div id="nav-config" class="main-nav-card bg-white rounded-xl shadow-sm p-4 text-center cursor-pointer">
                <div class="bg-indigo-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users h-6 w-6 text-indigo-600">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <h3 class="font-bold">พนักงาน</h3>
                <p class="nav-card-subtitle text-xs text-gray-500">จัดการข้อมูลและอัตราค่าใช้จ่าย</p>
            </div>
            <!-- Travel Expenses Navigation Card -->
             <div id="nav-travel" class="main-nav-card bg-white rounded-xl shadow-sm p-4 text-center cursor-pointer">
                <div class="bg-indigo-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin h-6 w-6 text-indigo-600">
                        <path d="M12 17.5V22"/>
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                        <circle cx="12" cy="9" r="2.5"/>
                    </svg>
                </div>
                <h3 class="font-bold">ค่าเดินทาง</h3>
                <p class="nav-card-subtitle text-xs text-gray-500">คำนวณค่าเดินทางประเภทต่างๆ</p>
            </div>
            <!-- Assistance and Overtime Navigation Card -->
             <div id="nav-assistance" class="main-nav-card bg-white rounded-xl shadow-sm p-4 text-center cursor-pointer">
                <div class="bg-indigo-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet-cards h-6 w-6 text-indigo-600">
                        <rect width="18" height="18" x="3" y="3" rx="2"/>
                        <path d="M3 9.5a2.5 2.5 0 0 1 2.5-2.5h13a2.5 2.5 0 0 1 2.5 2.5v0A2.5 2.5 0 0 1 18.5 12h-13A2.5 2.5 0 0 1 3 9.5v0"/>
                        <path d="M15 16h.01"/>
                        <path d="M12 16h.01"/>
                    </svg>
                </div>
                <h3 class="font-bold">เงินช่วยเหลือ</h3>
                <p class="nav-card-subtitle text-xs text-gray-500">เงินช่วยเหลือและค่าล่วงเวลา</p>
            </div>
            <!-- Workday Calculation Navigation Card -->
             <div id="nav-workday" class="main-nav-card bg-white rounded-xl shadow-sm p-4 text-center cursor-pointer">
                <div class="bg-indigo-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar h-6 w-6 text-indigo-600">
                        <path d="M8 2v4"/>
                        <path d="M16 2v4"/>
                        <rect width="18" height="18" x="3" y="4" rx="2"/>
                        <path d="M3 10h18"/>
                    </svg>
                </div>
                <h3 class="font-bold">วันทำงาน</h3>
                <p class="nav-card-subtitle text-xs text-gray-500">คำนวณวันทำงานและวันหยุด</p>
            </div>
            <!-- Summary Navigation Card -->
            <div id="nav-summary" class="main-nav-card bg-white rounded-xl shadow-sm p-4 text-center cursor-pointer">
                <div class="bg-indigo-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list h-6 w-6 text-indigo-600">
                        <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                        <path d="M12 11h4"/>
                        <path d="M12 16h4"/>
                        <path d="M8 11h.01"/>
                        <path d="M8 16h.01"/>
                    </svg>
                </div>
                <h3 class="font-bold">สรุปงบประมาณ</h3>
                <p class="nav-card-subtitle text-xs text-gray-500">ภาพรวมงบประมาณรายปี</p>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Budget View Section -->
            <div id="view-budget" class="main-view hidden">
                 <header class="bg-white text-gray-800 p-4 rounded-t-xl flex flex-wrap justify-between items-center gap-4 border-b">
                    <div>
                        <h2 class="text-xl font-bold">ตารางงบประมาณประจำปี</h2>
                        <p class="text-sm text-gray-500">จัดการและเปรียบเทียบงบประมาณรายจ่าย</p>
                    </div>
                    <div class="flex items-center gap-4 no-print">
                        <div class="flex items-center gap-2 bg-gray-100 p-2 rounded-lg">
                             <!-- Previous Year Button -->
                             <button id="budget-prev-year-btn" class="p-1 rounded-md hover:bg-gray-200 transition-colors" title="ปีก่อนหน้า">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                             </button>
                             <!-- Year Selectors -->
                             <div class="flex items-center gap-2 text-sm font-semibold">
                                <select id="select-year-current" class="bg-transparent border-none text-gray-700 focus:ring-0 p-0"></select>
                                <span>vs</span>
                                <select id="select-year-next" class="bg-transparent border-none text-gray-700 focus:ring-0 p-0"></select>
                             </div>
                             <!-- Next Year Button -->
                             <button id="budget-next-year-btn" class="p-1 rounded-md hover:bg-gray-200 transition-colors" title="ปีถัดไป">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                             </button>
                        </div>
                        <!-- Print Budget Button -->
                        <button id="print-budget-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 transition-colors">พิมพ์</button>
                    </div>
                </header>
                <div class="bg-white p-4 rounded-b-xl shadow-lg">
                    <table class="w-full text-sm border-collapse">
                        <thead id="budget-table-head">
                            <!-- Table header dynamically generated by JS -->
                        </thead>
                        <tbody id="budget-table-body-new">
                            <!-- Table content dynamically generated by JS -->
                        </tbody>
                        <tfoot class="font-bold bg-gray-100">
                            <tr id="budget-table-footer-new">
                                 <td colspan="4" class="px-4 py-3 text-lg">รวมงบประมาณรายจ่ายทั้งสิ้น</td>
                                 <td class="px-4 py-3 text-right text-lg" id="grand-total-current">0.00</td>
                                 <td class="px-4 py-3 text-right text-lg" id="grand-total-next">0.00</td>
                                 <td></td>
                            </tr>
                        </tfoot>
                    </table>
                     <div class="mt-4 flex justify-start">
                        <!-- Add New Budget Item Button -->
                        <button onclick="addBudgetItem()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm no-print">เพิ่มรายการใหม่</button>
                    </div>
                </div>
            </div>

            <!-- Config View Section (Master Rates and Employee List) -->
            <div id="view-config" class="main-view hidden bg-white p-6 rounded-xl shadow-lg space-y-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ตารางอัตราค่าใช้จ่ายมาตรฐาน</h2>
                    <div class="overflow-x-auto"><table id="master-rates-table" class="w-full text-sm text-left"></table></div>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">รายชื่อพนักงาน</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2">รหัสพนักงาน</th>
                                    <th class="px-4 py-2">ชื่อ-สกุล</th>
                                    <th class="px-4 py-2">สถานะ</th>
                                    <th class="px-4 py-2 text-center">เพศ</th>
                                    <th class="px-4 py-2">ปีเริ่มงาน</th>
                                    <th class="px-4 py-2">ระดับ</th>
                                    <th class="px-4 py-2">จังหวัดเยี่ยมบ้าน</th>
                                    <th class="px-4 py-2 text-right">ค่ารถทัวร์เยี่ยมบ้าน</th>
                                    <th class="px-4 py-2 text-center">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="employee-list-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-start">
                        <!-- Add New Employee Button -->
                        <button onclick="addEmployee()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm">เพิ่มพนักงานใหม่</button>
                    </div>
                </div>
            </div>

            <!-- Travel Group View Section -->
            <div id="view-travel" class="main-view hidden space-y-6">
                <header class="bg-white text-gray-800 p-4 rounded-t-xl flex flex-wrap justify-between items-center gap-4 border-b">
                    <div>
                        <h2 class="text-xl font-bold">ค่าเดินทาง</h2>
                        <p class="text-sm text-gray-500">คำนวณค่าเดินทางประเภทต่างๆ</p>
                    </div>
                    <div class="flex items-center justify-end flex-grow gap-4 bg-gray-100 p-2 rounded-lg">
                        <button id="prev-travel-year-btn" title="ปีก่อนหน้า" class="p-2 rounded-full bg-gray-200 hover:bg-indigo-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <div class="text-center">
                            <div class="text-sm text-gray-600">คำนวณสำหรับปี พ.ศ.</div>
                            <div id="display-travel-year" class="text-2xl font-bold text-indigo-600"></div>
                        </div>
                        <button id="next-travel-year-btn" title="ปีถัดไป" class="p-2 rounded-full bg-gray-200 hover:bg-indigo-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </header>

                <div class="bg-white p-4 border-b-2">
                    <nav class="flex justify-center gap-4 sm:gap-8">
                        <button id="sub-nav-travel-souvenir-tab" class="sub-nav-button active flex items-center gap-2 py-2 px-1 border-b-2 border-transparent font-semibold" data-target="sub-view-travel-souvenir-content">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gift h-5 w-5">
                                <polyline points="20 12 12 20 4 12"/>
                                <line x1="12" x2="12" y1="12" y2="20"/>
                                <path d="M20 12v-2a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/>
                                <path d="M12 4h.01"/>
                                <path d="M12 8h.01"/>
                                <path d="M12 16h.01"/>
                                <path d="M12 20h.01"/>
                            </svg>
                            ค่าของที่ระลึก
                        </button>
                        <button id="sub-nav-travel-family-tab" class="sub-nav-button flex items-center gap-2 py-2 px-1 border-b-2 border-transparent font-semibold" data-target="sub-view-travel-family-content">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home h-5 w-5">
                                <path d="M12 2L3 9h3v12h12v-12h3L12 2z"/>
                                <path d="M9 22v-6c0-1.1.9-2 2-2h2c1.1 0 2 .9 2 2v6"/>
                            </svg>
                            เยี่ยมครอบครัว
                        </button>
                        <button id="sub-nav-travel-company-tab" class="sub-nav-button flex items-center gap-2 py-2 px-1 border-b-2 border-transparent font-semibold" data-target="sub-view-travel-company-content">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bus h-5 w-5">
                                <path d="M16 20h2c2.2 0 4-1.8 4-4V8c0-2.2-1.8-4-4-4H6c-2.2 0-4 1.8-4 4v8c0 2.2 1.8 4 4 4h2"/>
                                <path d="M18 8V4"/>
                                <path d="M6 8V4"/>
                                <path d="M2 16h20"/>
                                <path d="M7 20v-4"/>
                                <path d="M17 20v-4"/>
                                <path d="M10 20h4"/>
                                <path d="M10 8h4"/>
                                <path d="M12 12h.01"/>
                            </svg>
                            ร่วมงานพนักงาน
                        </button>
                        <button id="sub-nav-travel-manager-tab" class="sub-nav-button flex items-center gap-2 py-2 px-1 border-b-2 border-transparent font-semibold" data-target="sub-view-travel-manager-content">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw h-5 w-5">
                                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1.04 6.64 2.87L21 8"/>
                                <path d="M21 3v5h-5"/>
                            </svg>
                            หมุนเวียน ผจศ.
                        </button>
                    </nav>
                </div>

                <div id="travel-sub-views-container" class="bg-white p-6 rounded-b-xl shadow-lg">
                    <!-- Souvenir Travel -->
                    <div id="sub-view-travel-souvenir-content" class="travel-sub-view">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">สรุปค่าใช้จ่ายเดินทางเพื่อรับของที่ระลึก</h2>
                            <div class="flex items-center justify-end flex-grow gap-4">
                                <div class="text-center"><div class="text-sm text-gray-600">คำนวณสำหรับปี พ.ศ.</div><div id="display-travel-year-souvenir" class="text-2xl font-bold text-indigo-600"></div></div>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">ชื่อ-สกุล</th><th class="px-4 py-2 text-center">อายุงาน</th><th class="px-4 py-2 text-center">วันตามกำหนดการ</th><th class="px-4 py-2 text-right">ค่าที่พัก</th><th class="px-4 py-2 text-right">ค่าเบี้ยเลี้ยง</th><th class="px-4 py-2 text-right">ค่ารถประจำทาง</th><th class="px-4 py-2 text-right">ค่ารถรับจ้าง</th><th class="px-4 py-2 text-right font-bold">รวม</th></tr></thead><tbody id="travel-employee-list"></tbody></table></div>
                        <div class="mt-6 pt-6 border-t-2 flex flex-col sm:flex-row justify-between items-center gap-4"><div class="flex items-center gap-4"><span class="text-lg font-bold">ยอดรวม:</span><span id="travel-total-cost" class="text-2xl font-bold text-indigo-600">0.00 บาท</span></div><button id="apply-travel-total-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">นำยอดรวมไปตั้งงบ</button></div>
                    </div>
                    <!-- Family Visit -->
                    <div id="sub-view-travel-family-content" class="travel-sub-view hidden">
                         <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">สรุปค่าเดินทางเยี่ยมครอบครัว</h2>
                            <div class="flex items-center justify-end flex-grow gap-4">
                                <div class="text-center"><div class="text-sm text-gray-600">คำนวณสำหรับปี พ.ศ.</div><div id="display-family-visit-year-family" class="text-2xl font-bold text-indigo-600"></div></div>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">รหัสพนักงาน</th><th class="px-4 py-2">ชื่อ-สกุล</th><th class="px-4 py-2">จังหวัด</th><th class="px-4 py-2 text-right">ค่ารถทัวร์</th><th class="px-4 py-2 text-right font-bold">รวม (บาท)</th></tr></thead><tbody id="family-visit-list"></tbody></table></div>
                        <div class="mt-6 pt-6 border-t-2 flex flex-col sm:flex-row justify-between items-center gap-4"><div class="flex items-center gap-4"><span class="text-lg font-bold">ยอดรวม:</span><span id="family-visit-total" class="text-2xl font-bold text-indigo-600">0.00 บาท</span></div><button id="apply-family-visit-total-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">นำยอดรวมไปตั้งงบ</button></div>
                    </div>
                    <!-- Company Trip -->
                    <div id="sub-view-travel-company-content" class="travel-sub-view hidden">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">สรุปค่าเดินทางร่วมงานวันพนักงาน</h2>
                            <div class="flex items-center gap-4">
                                <label for="company-trip-bus-fare" class="font-semibold">ค่ารถทัวร์ (ไป-กลับ):</label>
                                <input type="number" id="company-trip-bus-fare" class="w-28 p-2 border border-gray-300 rounded-md" onchange="updateCompanyTripFare(this.value)">
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">ชื่อ-สกุล</th><th class="px-4 py-2 text-right">ค่ารถทัวร์</th><th class="px-4 py-2 text-right">ค่าที่พัก</th><th class="px-4 py-2 text-right font-bold">รวม (บาท)</th></tr></thead><tbody id="company-trip-list"></tbody></table></div>
                        <div class="mt-6 pt-6 border-t-2 flex justify-between items-center gap-4"><div class="flex items-center gap-4"><span class="text-lg font-bold">ยอดรวม:</span><span id="company-trip-total" class="text-2xl font-bold text-indigo-600">0.00 บาท</span></div></div>
                    </div>
                    <!-- Manager Rotation -->
                    <div id="sub-view-travel-manager-content" class="travel-sub-view hidden">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">สรุปค่าเดินทางหมุนเวียนงาน ผจศ.</h2>
                            <div class="flex items-center justify-end flex-grow gap-4">
                                <div class="text-center"><div class="text-sm text-gray-600">คำนวณสำหรับปี พ.ศ.</div><div id="display-manager-rotation-year-manager" class="text-2xl font-bold text-indigo-600"></div></div>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">ชื่อ-สกุล</th><th class="px-4 py-2 text-right">ค่าเบี้ยเลี้ยง</th><th class="px-4 py-2 text-right">ค่าที่พัก</th><th class="px-4 py-2 text-right">ค่าเดินทาง (คงที่)</th><th class="px-4 py-2 text-right">ค่าพาหนะอื่นๆ</th><th class="px-4 py-2 text-right font-bold">รวม</th></tr></thead><tbody id="manager-rotation-list"></tbody></table></div>
                        <div class="mt-6 pt-6 border-t-2 flex flex-col sm:flex-row justify-between items-center gap-4"><div class="flex items-center gap-4"><span class="text-lg font-bold">ยอดรวม:</span><span id="manager-rotation-total" class="text-2xl font-bold text-indigo-600">0.00 บาท</span></div><button id="apply-manager-rotation-total-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">นำยอดรวมไปตั้งงบ</button></div>
                    </div>
                </div>
            </div>

            <!-- Assistance Group View Section -->
            <div id="view-assistance" class="main-view hidden">
                <header class="bg-violet-700 text-white p-6 rounded-t-xl">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold">จัดการเงินช่วยเหลือและค่าต่างเวลา</h2>
                            <p class="text-violet-200">คำนวณและจัดการเงินช่วยเหลือประเภทต่างๆ</p>
                        </div>
                        <div class="flex items-center justify-end flex-grow gap-4 bg-violet-600/50 p-2 rounded-lg">
                            <!-- Previous Assistance Group Year Button -->
                            <button id="prev-assist-group-year-btn" title="ปีก่อนหน้า" class="p-2 rounded-full hover:bg-violet-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                            <div class="text-center">
                                <div class="text-sm text-violet-200">คำนวณสำหรับปี พ.ศ.</div>
                                <div id="display-assist-group-year" class="text-2xl font-bold"></div>
                            </div>
                            <!-- Next Assistance Group Year Button -->
                            <button id="next-assist-group-year-btn" title="ปีถัดไป" class="p-2 rounded-full hover:bg-violet-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                    </div>
                </header>
                <div class="bg-white p-4 border-b-2">
                    <nav class="flex justify-center gap-4 sm:gap-8">
                        <button id="sub-nav-assist-other" class="sub-nav-button flex items-center gap-2 py-2 px-1 border-b-2 border-transparent font-semibold"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.155-.103.346-.103.501 0l4.25 2.833c.154.103.22.303.16.484a.5.5 0 01-.608.318l-4.25-2.833a.5.5 0 01-.16-.484z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0 1a9 9 0 100-18 9 9 0 000 18z" clip-rule="evenodd" /></svg>เงินช่วยเหลืออื่นๆ</button>
                        <button id="sub-nav-assist-special" class="sub-nav-button flex items-center gap-2 py-2 px-1 border-b-2 border-transparent font-semibold"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 5a3 3 0 015.252-2.121l.738.737a.5.5 0 00.708 0l.737-.737A3 3 0 1115 7.228v.002a.5.5 0 00-.5-.5h-.002a.5.5 0 01-.5-.5V5z" clip-rule="evenodd" /></svg>เงินช่วยเหลือพิเศษ</button>
                        <button id="sub-nav-assist-overtime" class="sub-nav-button flex items-center gap-2 py-2 px-1 border-b-2 border-transparent font-semibold"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>ค่าล่วงเวลาวันหยุด</button>
                    </nav>
                </div>

                <div class="bg-white p-6 rounded-b-xl shadow-lg">
                    <!-- KPI Cards Container -->
                    <div id="kpi-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>
                    
                    <!-- Sub View Content: Other Assistance -->
                    <div id="sub-view-assist-other" class="sub-view hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2">รหัสพนักงาน</th>
                                        <th class="px-4 py-2">ชื่อ-สกุล</th>
                                        <th class="px-4 py-2 text-right">ค่าเช่า (ต่อปี)</th>
                                        <th class="px-4 py-2 text-center">จำนวนเดือน</th>
                                        <th class="px-4 py-2 text-right">เงินช่วยเหลือ (ต่อปี)</th>
                                        <th class="px-4 py-2 text-right">ค่าซื้อของ (ครั้งเดียว)</th>
                                        <th class="px-4 py-2 text-right font-bold">รวม (บาท)</th>
                                    </tr>
                                </thead>
                                <tbody id="special-assist-list"></tbody>
                            </table>
                        </div>
                        <div class="mt-6 pt-6 border-t-2 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4">
                               <span class="text-lg font-bold">ยอดรวม:</span>
                               <span id="special-assist-total" class="text-2xl font-bold text-indigo-600">0.00 บาท</span>
                            </div>
                            <!-- Apply Special Assistance Total to Budget Button -->
                            <button id="apply-special-assist-total-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">นำยอดรวมไปตั้งงบ</button>
                        </div>
                    </div>
                    <!-- Sub View Content: Special Assistance 1 -->
                    <div id="sub-view-assist-special" class="sub-view hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 w-auto">รายการ</th>
                                        <th class="px-4 py-2 text-center">ครั้ง/ปี</th>
                                        <th class="px-4 py-2 text-center">วัน/ครั้ง</th>
                                        <th class="px-4 py-2 text-center">คน/ครั้ง</th>
                                        <th class="px-4 py-2 text-right">ช่วยเหลือ/วัน</th>
                                        <th class="px-4 py-2 text-right">รวมเงิน</th>
                                    </tr>
                                </thead>
                                <tbody id="special-assist-1-list"></tbody>
                                <tfoot class="font-bold bg-gray-100">
                                    <tr class="border-t-2 border-gray-300">
                                        <td colspan="5" class="px-4 py-3 text-lg text-right">ยอดรวม</td>
                                        <td id="special-assist-1-total" class="px-4 py-3 text-right text-lg">0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="mt-6 pt-6 border-t-2">
                            <label for="special-assist-1-notes" class="block text-lg font-bold mb-2">หมายเหตุ:</label>
                            <textarea id="special-assist-1-notes" rows="3" class="w-full p-2 border border-gray-300 rounded-md" onchange="updateSpecialAssist1Notes(this.value)"></textarea>
                        </div>
                    </div>
                    <!-- Sub View Content: Overtime -->
                    <div id="sub-view-assist-overtime" class="sub-view hidden">
                        <div class="mb-6">
                            <label for="overtime-salary" class="font-bold text-gray-700">เงินเดือน (สำหรับคำนวณอัตราจ่าย):</label>
                            <input type="number" id="overtime-salary" class="mt-1 w-full max-w-xs p-2 border border-gray-300 rounded-md" onchange="updateOvertimeData('salary', this.value)">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2">ประเภทวันหยุดยาว</th>
                                        <th class="px-4 py-2 text-center">จำนวนครั้ง</th>
                                        <th class="px-4 py-2 text-center">ชม./วัน</th>
                                        <th class="px-4 py-2 text-center">จำนวนคน</th>
                                        <th class="px-4 py-2 text-right">อัตราจ่าย/ชม.</th>
                                        <th class="px-4 py-2 text-right">รวม</th>
                                    </tr>
                                </thead>
                                <tbody id="overtime-list"></tbody>
                                <tfoot class="font-bold bg-gray-100">
                                    <tr class="border-t-2 border-gray-300">
                                        <td colspan="5" class="px-4 py-3 text-lg text-right">ยอดรวมทั้งหมด</td>
                                        <td id="overtime-total" class="px-4 py-3 text-right text-lg">0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="mt-6 pt-6 border-t-2 flex flex-col sm:flex-row justify-end items-center gap-4">
                            <!-- Apply Overtime Total to Budget Button -->
                            <button id="apply-overtime-total-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">นำยอดรวมไปตั้งงบ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workday View Section -->
            <div id="view-workday" class="main-view hidden bg-white p-6 rounded-xl shadow-lg">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">คำนวณและจัดการวันทำงานประจำปี</h2>
                    <div class="flex items-center justify-end flex-grow gap-4">
                         <!-- Previous Workday Year Button -->
                         <button id="prev-workday-year-btn" title="ปีก่อนหน้า" class="p-2 rounded-full bg-gray-200 hover:bg-indigo-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                        <div class="text-center"><div class="text-sm text-gray-600">คำนวณสำหรับปี พ.ศ.</div><div id="display-workday-year" class="text-2xl font-bold text-indigo-600"></div></div>
                        <!-- Next Workday Year Button -->
                        <button id="next-workday-year-btn" title="ปีถัดไป" class="p-2 rounded-full bg-gray-200 hover:bg-indigo-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div id="workday-results-container">
                        <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                            <h3 class="text-xl font-bold text-gray-800">ผลการคำนวณ</h3>
                            <p class="text-center text-gray-500 py-8">กรุณาเลือกปี</p>
                        </div>
                    </div>
                    <div id="holiday-management-container" class="hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">จัดการวันหยุดสถาบันการเงิน</h3>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <h4 class="font-semibold mb-2">เพิ่มวันหยุดใหม่</h4>
                            <div class="flex items-center gap-2">
                                <input type="date" id="new-holiday-date" class="p-2 border border-gray-300 rounded-md flex-grow">
                                <input type="text" id="new-holiday-name" placeholder="ชื่อวันหยุด" class="p-2 border border-gray-300 rounded-md flex-grow">
                                <button id="add-holiday-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">เพิ่ม</button>
                            </div>
                        </div>
                        <div id="holiday-list-editor"></div>
                    </div>
                </div>
            </div>

            <!-- Summary View Section -->
            <div id="view-summary" class="main-view hidden bg-white p-6 rounded-xl shadow-lg space-y-8">
                <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">สรุปงบประมาณประจำปี</h2>
                    <div class="flex items-center justify-end flex-grow gap-4 bg-gray-100 p-2 rounded-lg">
                        <button id="prev-summary-year-btn" title="ปีก่อนหน้า" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <div class="text-center">
                            <div class="text-sm text-gray-600">สรุปสำหรับปี พ.ศ.</div>
                            <div id="display-summary-year" class="text-2xl font-bold text-indigo-600"></div>
                        </div>
                        <button id="next-summary-year-btn" title="ปีถัดไป" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </header>

                <!-- Operational Expenditure Summary -->
                <div class="border rounded-lg p-4 bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">สรุปงบประมาณรายจ่ายดำเนินงาน</h3>
                    <div id="operational-summary-content" class="space-y-2">
                        <!-- Content generated by JS -->
                    </div>
                    <div class="border-t pt-3 mt-3 flex justify-between items-center text-lg font-bold">
                        <span>ยอดรวมรายจ่ายดำเนินงาน:</span>
                        <span id="operational-grand-total" class="text-indigo-700">0.00 บาท</span>
                    </div>
                </div>

                <!-- Travel Expenses Summary -->
                <div class="border rounded-lg p-4 bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">สรุปค่าใช้จ่ายเดินทาง</h3>
                    <div id="travel-summary-content" class="space-y-2">
                        <!-- Content generated by JS -->
                    </div>
                    <div class="border-t pt-3 mt-3 flex justify-between items-center text-lg font-bold">
                        <span>ยอดรวมค่าใช้จ่ายเดินทาง:</span>
                        <span id="travel-grand-total" class="text-indigo-700">0.00 บาท</span>
                    </div>
                </div>

                <!-- Assistance Summary -->
                <div class="border rounded-lg p-4 bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">สรุปเงินช่วยเหลือ</h3>
                    <div id="assistance-summary-content" class="space-y-2">
                        <!-- Content generated by JS -->
                    </div>
                    <div class="border-t pt-3 mt-3 flex justify-between items-center text-lg font-bold">
                        <span>ยอดรวมเงินช่วยเหลือ:</span>
                        <span id="assistance-grand-total" class="text-indigo-700">0.00 บาท</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Alert Modal -->
    <div id="alert-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform transition-all scale-95">
            <h3 id="alert-title" class="text-xl font-bold mb-4">สำเร็จ!</h3>
            <p id="alert-message" class="text-gray-700 mb-6">ข้อมูลถูกบันทึกเรียบร้อยแล้ว</p>
            <button id="alert-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">ตกลง</button>
        </div>
    </div>
    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform transition-all scale-95">
            <h3 id="confirm-title" class="text-xl font-bold mb-4">ยืนยันการกระทำ</h3>
            <p id="confirm-message" class="text-gray-700 mb-6">คุณแน่ใจหรือไม่?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">ยกเลิก</button>
                <button id="confirm-ok-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">ยืนยัน</button>
            </div>
        </div>
    </div>
    <!-- Hidden input for file import -->
    <input type="file" id="import-config-input" class="hidden" accept=".xlsx, .xls">

    <script>
        // --- DATA SOURCE (DEFAULTS) ---
        // Default budget items with their types, codes, names, and initial empty values for future years.
        const defaultBudgetItems = [
            { type: 'main_header', name: 'รวมงบประมาณรายจ่ายดำเนินงาน' },
            { type: 'header', name: 'หมวด 1 : ค่าใช้จ่ายเกี่ยวกับพนักงาน' },
            { budgetCode: '52021100', code: '52021100', name: 'ค่าใช้จ่ายกิจกรรมส่งเสริมค่านิยมร่วมขององค์กร' },
            { type: 'header', name: 'หมวด 2 : ค่าใช้จ่ายดำเนินงานทั่วไป' },
            { budgetCode: '53010200', code: '53010200', name: 'ค่าไฟฟ้า' },
            { budgetCode: '53010300', code: '53010300', name: 'ค่าน้ำประปา' },
            { budgetCode: '53010400', code: '53010400', name: 'ค่าโทรศัพท์' },
            { budgetCode: '53040100', code: '53040100', name: 'ค่าวัสดุทั่วไป' },
            { budgetCode: '53040200', code: '53040200', name: 'ค่าวัสดุงานบ้านงานครัว' },
            { budgetCode: '53100001', code: '53100001', name: 'ค่าจ้าง' },
            { budgetCode: '', code: '53010100', name: 'ค่าไปรษณียากรและพัสดุไปรษณีย์' },
            { budgetCode: '', code: '53050500', name: 'ค่าขนส่ง' },
            { budgetCode: '', code: '53100400', name: 'ค่าจ้างแรงงานและทำของ' },
            { budgetCode: '', code: '53103900', name: 'ค่าจ้างแรงงาน/ทำของ-งานตามพันธกิจหลัก' },
            { budgetCode: '53100002', code: '53021100', name: 'ค่าซ่อมแซมและบำรุงรักษา' },
            { budgetCode: '53100003', code: '53060600', name: 'ค่าตอบแทน' },
            { budgetCode: '53100004', code: '53100004', name: 'ค่าเช่า' },
            { budgetCode: '', code: '53040300', name: 'ค่าเช่าเครื่องถ่ายเอกสาร' },
            { budgetCode: '', code: '53050200', name: 'ค่าเช่ายานพาหนะ' },
            { budgetCode: '53100005', code: '53070400', name: 'ค่าธรรมเนียม' },
            { budgetCode: '53100100', code: '53100100', name: 'ค่ารับรอง' },
            { budgetCode: '53100200', code: '53100200', name: 'ค่าใช้จ่ายในการเดินทาง' },
            { budgetCode: '53101000', code: '53101000', name: 'ค่าทรัพยากรสาสนเทศห้องสมุด' },
            { budgetCode: '53103600', code: '53103600', name: 'ค่าจัดประชุม/ชี้แจง' },
            { budgetCode: '53101500', code: '53101500', name: 'ค่าใช้จ่ายในการจัดงานและพิธีต่าง ๆ' },
            { budgetCode: '53109900', code: '53109900', name: 'ค่าใช้จ่ายเบ็ดเตล็ด' },
            { type: 'header', name: 'หมวด 4 : เงินช่วยเหลือภายนอกและเงินบริจาค' },
            { budgetCode: '55000001', code: '55080300', name: 'เงินบริจาค' },
            { type: 'header', name: 'หมวด 58: ค่าใช้จ่ายด้านการผลิต' },
            { budgetCode: '58030700', code: '53110700', name: 'ค่าวัสดุผลิต - ทั่วไป' },
            { type: 'main_header', name: 'รวมงบประมาณรายจ่ายสินทรัพย์' },
            { type: 'header', name: 'หมวด 7 : สินทรัพย์ถาวร' },
            { code: '10', name: 'ครุภัณฑ์เครื่องใช้ไฟฟ้าและประปา' },
            { code: '16', name: 'ครุภัณฑ์เบ็ดเตล็ด' },
            { code: '25', name: 'ครุภัณฑ์ยานพาหนะและขนส่ง' },
            { code: '5', name: 'ค่าเสริมสร้างปรับปรุงอาคารสถานที่' },
        ].map(item => ({...item, notes: ''})); // Add notes field to each item

        let masterRates = {};
        // Default master rates for different employee levels
        const defaultMasterRates = { '7': { position: 'ผู้บริหารส่วน', rent: 9500, monthlyAssist: 6250, lumpSum: 8000, travel: 300, local: 250, perDiem: 500, hotel: 2100 }, '6': { position: 'ผู้บริหารทีม', rent: 9500, monthlyAssist: 6250, lumpSum: 8000, travel: 300, local: 250, perDiem: 500, hotel: 2100 }, '5.5': { position: 'เจ้าหน้าที่ชำนาญงาน (ควบ)', rent: 9500, monthlyAssist: 6250, lumpSum: 6000, travel: 300, local: 250, perDiem: 500, hotel: 2100 }, '5': { position: 'เจ้าหน้าที่ชำนาญงาน', rent: 8000, monthlyAssist: 5500, lumpSum: 6000, travel: 300, local: 250, perDiem: 450, hotel: 1800 }, '4.5': { position: 'เจ้าหน้าที่ (ควบ)', rent: 8000, monthlyAssist: 5500, lumpSum: 6000, travel: 300, local: 250, perDiem: 450, hotel: 1800 }, '4': { position: 'เจ้าหน้าที่', rent: 8000, monthlyAssist: 5500, lumpSum: 6000, travel: 300, local: 250, perDiem: 450, hotel: 1800 }, '3': { position: 'พนักงานปฏิบัติการ', rent: 6500, monthlyAssist: 4750, lumpSum: 5000, travel: 300, local: 250, perDiem: 450, hotel: 1800 } };
        // Default employee master data
        const defaultEmployeeMasterData = [ { id: '62539086', name: 'พัทธดนย์ ทรัพย์ประสม', gender: 'ชาย', startYear: 2539, level: '7', visitProvince: 'พิษณุโลก', homeVisitBusFare: 1200, status: 'Active' }, { id: '52531175', name: 'พีรนุช ธนบดีภัทร', gender: 'หญิง', startYear: 2531, level: '6', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600, status: 'Active' }, { id: '82532130', name: 'นลินรัตน์ ตรีไพศาลศักดิ์', gender: 'หญิง', startYear: 2532, level: '5.5', visitProvince: 'ขอนแก่น', homeVisitBusFare: 0, status: 'Active' }, { id: '42538115', name: 'อุมารักษ์ เตลันยืน', gender: 'หญิง', startYear: 2538, level: '4', visitProvince: '', homeVisitBusFare: 0, status: 'Active' }, { id: '42538092', name: 'สมควร กลิ่นสุคนธ์', gender: 'หญิง', startYear: 2538, level: '4', visitProvince: '', homeVisitBusFare: 0, status: 'Active' }, { id: '52542046', name: 'สรวิชญ์ ธรรศเดชา', gender: 'ชาย', startYear: 2542, level: '5', visitProvince: '', homeVisitBusFare: 600, status: 'Active' }, { id: '22538173', name: 'ประภัสสร เล็กศรีสกุล', gender: 'หญิง', startYear: 2538, level: '5', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600, status: 'Active' }, { id: '82542011', name: 'มลธิรา สุขสำราญ', gender: 'หญิง', startYear: 2542, level: '5', visitProvince: 'ขอนแก่น', homeVisitBusFare: 1200, status: 'Active' }, { id: '42539087', name: 'สุภาณี จำปานุ้ย', gender: 'หญิง', startYear: 2539, level: '5', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600, status: 'Active' }, { id: '62537025', name: 'วิชญ อุปันนัทธ์', gender: 'ชาย', startYear: 2537, level: '5', visitProvince: 'เชียงใหม่', homeVisitBusFare: 600, status: 'Active' }, { id: '82536096', name: 'นุสรา อัศวโชคชัย', gender: 'หญิง', startYear: 2536, level: '5', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600, status: 'Active' }, { id: '72539071', name: 'สันติภาพ ทองประดี', gender: 'ชาย', startYear: 2539, level: '5', visitProvince: 'ขอนแก่น', homeVisitBusFare: 0, status: 'Active' }, { id: '82538194', name: 'ขวัญญาณัฐ จุลเกษม', gender: 'หญิง', startYear: 2538, level: '4.5', visitProvince: 'ขอนแก่น', homeVisitBusFare: 600, status: 'Active' }, { id: '52538087', name: 'สงวน ร้องเกาะเกิด', gender: 'ชาย', startYear: 2538, level: '3', visitProvince: '', homeVisitBusFare: 0, status: 'Active' }, { id: '2539140', name: 'สุมาพร จงภู่', gender: 'หญิง', startYear: 2539, level: '3', visitProvince: 'ขอนแก่น', homeVisitBusFare: 0, status: 'Active' }, { id: '42540033', name: 'คมสันติ์ นุชนารถ', gender: 'ชาย', startYear: 2540, level: '3', visitProvince: '', homeVisitBusFare: 0, status: 'Active' }, { id: '82540031', name: 'พิชิต แจ่มศรี', gender: 'ชาย', startYear: 2540, level: '3', visitProvince: '', homeVisitBusFare: 0, status: 'Active' }, ];
        // Default special assistance 1 data
        const defaultSpecialAssist1Data = [ { item: 'ควบคุมงานบำรุงรักษาระบบไฟฟ้าต้นกำลัง', timesPerYear: 1, days: 2, people: 1, rate: 250 }, { item: 'ควบคุมงานบำรุงรักษาระบบรักษาความปลอดภัย', timesPerYear: 2, days: 2, people: 1, rate: 250 }, { item: 'PM เครื่องจักร M7', timesPerYear: 12, days: 2, people: 1, rate: 250 }, { item: 'Mini Overhaul เครื่อง M7', timesPerYear: 1, days: 2, people: 1, rate: 250 }, { item: 'พนักงานทำงานผลิต', timesPerYear: 1, days: 242, people: 2, rate: 300 }, { item: 'พนักงานควบคุมการตรวจจับวันเสาร์ อาทิตย์', timesPerYear: 1, days: 20, people: 1, rate: 300 }, { item: 'ควบคุมงานล้างบ่อประปา', timesPerYear: 1, days: 2, people: 1, rate: 250 }, ];
        // Holiday data by year (Gregorian calendar year)
        const holidaysByYear = { 2021: [ { date: '2021-01-01', name: 'วันขึ้นปีใหม่' }, { date: '2021-02-26', name: 'วันมาฆบูชา' }, { date: '2021-04-06', name: 'วันจักรี' }, { date: '2021-04-13', name: 'วันสงกรานต์' }, { date: '2021-04-14', name: 'วันสงกรานต์' }, { date: '2021-04-15', name: 'วันสงกรานต์' }, { date: '2021-05-03', name: 'ชดเชยวันแรงงาน' }, { date: '2021-05-04', name: 'วันฉัตรมงคล' }, { date: '2021-05-26', name: 'วันวิสาขบูชา' }, { date: '2021-06-03', name: 'วันเฉลิมฯ พระราชินี' }, { date: '2021-07-26', name: 'ชดเชยวันอาสาฬหบูชา' }, { date: '2021-07-28', name: 'วันเฉลิมฯ ร.10' }, { date: '2021-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' }, { date: '2021-10-13', name: 'วันคล้ายวันสวรรคต ร.9' }, { date: '2021-10-25', name: 'ชดเชยวันปิยมหาราช' }, { date: '2021-12-06', name: 'ชดเชยวันคล้ายวันพระบรมราชสมภพ ร.9' }, { date: '2021-12-10', name: 'วันรัฐธรรมนูญ' }, { date: '2021-12-31', name: 'วันสิ้นปี' } ], 2022: [ { date: '2022-01-03', name: 'ชดเชยวันขึ้นปีใหม่' }, { date: '2022-02-16', name: 'วันมาฆบูชา' }, { date: '2022-04-06', name: 'วันจักรี' }, { date: '2022-04-13', name: 'วันสงกรานต์' }, { date: '2022-04-14', name: 'วันสงกรานต์' }, { date: '2022-04-15', name: 'วันสงกรานต์' }, { date: '2022-05-02', name: 'ชดเชยวันแรงงาน' }, { date: '2022-05-04', name: 'วันฉัตรมงคล' }, { date: '2022-05-16', name: 'ชดเชยวันวิสาขบูชา' }, { date: '2022-06-03', name: 'วันเฉลิมฯ พระราชินี' }, { date: '2022-07-13', name: 'วันอาสาฬหบูชา' }, { date: '2022-07-28', name: 'วันเฉลิมฯ ร.10' }, { date: '2022-07-29', name: 'วันหยุดพิเศษ' }, { date: '2022-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' }, { date: '2022-10-13', name: 'วันคล้ายวันสวรรคต ร.9' }, { date: '2022-10-14', name: 'วันหยุดพิเศษ' }, { date: '2022-10-24', name: 'ชดเชยวันปิยมหาราช' }, { date: '2022-12-05', name: 'วันคล้ายวันพระบรมราชสมภพ ร.9' }, { date: '2022-12-12', name: 'ชดเชยวันรัฐธรรมนูญ' } ], 2023: [ { date: '2023-01-02', name: 'ชดเชยวันสิ้นปีและวันขึ้นปีใหม่' }, { date: '2023-03-06', name: 'วันมาฆบูชา' }, { date: '2023-04-06', name: 'วันจักรี' }, { date: '2023-04-13', name: 'วันสงกรานต์' }, { date: '2023-04-14', name: 'วันสงกรานต์' }, { date: '2023-04-15', name: 'วันสงกรานต์' }, { date: '2023-05-01', name: 'วันแรงงานแห่งชาติ' }, { date: '2023-05-04', name: 'วันฉัตรมงคล' }, { date: '2023-06-05', name: 'ชดเชยวันวิสาขบูชาและวันเฉลิมฯ พระราชินี' }, { date: '2023-07-28', name: 'วันเฉลิมฯ ร.10' }, { date: '2023-08-01', name: 'วันอาสาฬหบูชา' }, { date: '2023-08-14', name: 'ชดเชยวันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' }, { date: '2023-10-13', name: 'วันนวมินทรมหาราช' }, { date: '2023-10-23', name: 'วันปิยมหาราช' }, { date: '2023-12-05', name: 'วันคล้ายวันพระบรมราชสมภพ ร.9' }, { date: '2023-12-11', name: 'ชดเชยวันรัฐธรรมนูญ' } ], 2024: [ { date: '2024-01-01', name: 'วันขึ้นปีใหม่' }, { date: '2024-02-26', name: 'ชดเชยวันมาฆบูชา' }, { date: '2024-04-08', name: 'ชดเชยวันจักรี' }, { date: '2024-04-15', name: 'วันสงกรานต์' }, { date: '2024-04-16', name: 'ชดเชยวันสงกรานต์' }, { date: '2024-05-01', name: 'วันแรงงานแห่งชาติ' }, { date: '2024-05-06', name: 'ชดเชยวันฉัตรมงคล' }, { date: '2024-05-22', name: 'วันวิสาขบูชา' }, { date: '2024-06-03', name: 'วันเฉลิมฯ พระราชินี' }, { date: '2024-07-22', name: 'ชดเชยวันอาสาฬหบูชา' }, { date: '2024-07-29', name: 'ชดเชยวันเฉลิมฯ ร.10' }, { date: '2024-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' }, { date: '2024-10-14', name: 'ชดเชยวันนวมินทรมหาราช' }, { date: '2024-10-23', name: 'วันปิยมหาราช' }, { date: '2024-12-05', name: 'วันคล้ายวันพระบรมราชสมภพ ร.9' }, { date: '2024-12-10', name: 'วันรัฐธรรมนูญ' }, { date: '2024-12-31', name: 'วันสิ้นปี' } ], 2025: [ { date: '2025-01-01', name: 'วันขึ้นปีใหม่' }, { date: '2025-02-12', name: 'วันมาฆบูชา' }, { date: '2025-04-07', name: 'ชดเชยวันจักรี' }, { date: '2025-04-14', name: 'วันสงกรานต์' }, { date: '2025-04-15', name: 'วันสงกรานต์' }, { date: '2025-05-01', name: 'วันแรงงานแห่งชาติ' }, { date: '2025-05-05', name: 'วันฉัตรมงคล' }, { date: '2025-05-12', name: 'วันวิสาขบูชา' }, { date: '2025-06-03', name: 'วันเฉลิมฯ พระราชินี' }, { date: '2025-07-28', name: 'วันเฉลิมฯ ร.10' }, { date: '2025-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' }, { date: '2025-10-13', name: 'วันนวมินทรมหาราช' }, { date: '2025-10-23', name: 'วันปิยมหาราช' }, { date: '2025-12-05', name: 'วันคล้ายวันพระบรมราชสมภพ ร.9' }, { date: '2025-12-10', name: 'วันรัฐธรรมนูญ' }, { date: '2025-12-31', name: 'วันสิ้นปี' } ], 2026: [ { date: '2026-01-01', name: 'วันขึ้นปีใหม่' }, { date: '2026-03-04', name: 'วันมาฆบูชา' }, { date: '2026-04-06', name: 'วันจักรี' }, { date: '2026-04-13', name: 'วันสงกรานต์' }, { date: '2026-04-14', name: 'วันสงกรานต์' }, { date: '2026-04-15', name: 'วันสงกรานต์' }, { date: '2026-05-01', name: 'วันแรงงานแห่งชาติ' }, { date: '2026-05-04', name: 'วันฉัตรมงคล' }, { date: '2026-06-01', name: 'วันวิสาขบูชา' }, { date: '2026-06-03', name: 'วันเฉลิมฯ พระราชินี' }, { date: '2026-07-28', name: 'วันเฉลิมฯ ร.10' }, { date: '2026-07-30', name: 'วันอาสาฬหบูชา' }, { date: '2026-08-12', name: 'วันเฉลิมฯ พระบรมราชชนนีพันปีหลวง' }, { date: '2026-10-13', name: 'วันนวมินทรมหาราช' }, { date: '2026-10-23', name: 'วันปิยมหาราช' }, { date: '2026-12-07', name: 'ชดเชยวันคล้ายวันพระบรมราชสมภพ ร.9' }, { date: '2026-12-10', name: 'วันรัฐธรรมนูญ' }, { date: '2026-12-31', name: 'วันสิ้นปี' } ] };
        
        // --- GLOBAL STATE & CALCULATION RESULTS ---
        let budgetData = []; // Stores the main budget items and their values for different years
        let employeeMasterData = []; // Stores employee details
        let specialAssist1DataByYear = {}; // Special assistance data, keyed by year
        let overtimeDataByYear = {}; // Overtime data, keyed by year
        let specialAssistOverridesByYear = {}; // Overrides for special assistance data, keyed by year and employee ID
        let souvenirTravelOverridesByYear = {}; // Overrides for souvenir travel data, keyed by year and employee ID
        let managerRotationOverridesByYear = {}; // Overrides for manager rotation data, keyed by year and employee ID
        let companyTripBusFare = 600; // Default company trip bus fare
        let travelCalcYear, familyVisitCalcYear, managerRotationCalcYear, workdayCalcYear; // Current calculation years for different sections
        let assistGroupCalcYear; // Current calculation year for assistance group
        let summaryCalcYear; // Current calculation year for the summary page
        let calculatedTravelEmployees = [], calculatedSpecialAssistData = [], calculatedFamilyVisitData = [], calculatedManagerRotationData = []; // Results of calculations
        let calculatedCompanyTripTotalValue = 0; // Store the calculated company trip total

        // --- UTILITY & MODAL FUNCTIONS ---
        // Formats a number as Thai currency with two decimal places.
        const formatCurrency = (num) => new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
        // Get references to modal elements
        const alertModal = document.getElementById('alert-modal');
        const confirmModal = document.getElementById('confirm-modal');
        let confirmCallback = null; // Callback function for the confirm modal
        // Shows a given modal with a fade-in and scale-up effect.
        function showModal(modal) { modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10); }
        // Hides a given modal with a fade-out and scale-down effect.
        function hideModal(modal) { modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 250); }
        // Displays an alert modal with a given title and message.
        function showAlert(title, message) { document.getElementById('alert-title').textContent = title; document.getElementById('alert-message').textContent = message; showModal(alertModal); }
        // Displays a confirmation modal with a given title, message, and a callback function for confirmation.
        function showConfirm(title, message, onConfirm) { document.getElementById('confirm-title').textContent = title; document.getElementById('confirm-message').textContent = message; confirmCallback = onConfirm; showModal(confirmModal); }

        // --- DATA PERSISTENCE (LOCALSTORAGE) ---
        // Define keys for storing data in local storage
        const STORAGE_KEY_BUDGET = 'budgetSystem_budgetData_v4_ui';
        const STORAGE_KEY_EMPLOYEES = 'budgetSystem_employeeData_v4_ui';
        const STORAGE_KEY_ASSIST1 = 'budgetSystem_assist1Data_v4_ui';
        const STORAGE_KEY_OVERTIME = 'budgetSystem_overtimeData_v4_ui';
        const STORAGE_KEY_MASTER_RATES = 'budgetSystem_masterRates_v4_ui';
        const STORAGE_KEY_ASSIST_OVERRIDES = 'budgetSystem_assistOverrides_v1';
        const STORAGE_KEY_SOUVENIR_OVERRIDES = 'budgetSystem_souvenirOverrides_v1';
        const STORAGE_KEY_MANAGER_ROTATION_OVERRIDES = 'budgetSystem_managerRotationOverrides_v1';
        const STORAGE_KEY_COMPANY_TRIP_FARE = 'budgetSystem_companyTripFare_v1';
        
        // Saves all current application data to local storage.
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY_BUDGET, JSON.stringify(budgetData));
                localStorage.setItem(STORAGE_KEY_EMPLOYEES, JSON.stringify(employeeMasterData));
                localStorage.setItem(STORAGE_KEY_ASSIST1, JSON.stringify(specialAssist1DataByYear));
                localStorage.setItem(STORAGE_KEY_OVERTIME, JSON.stringify(overtimeDataByYear));
                localStorage.setItem(STORAGE_KEY_MASTER_RATES, JSON.stringify(masterRates));
                localStorage.setItem(STORAGE_KEY_ASSIST_OVERRIDES, JSON.stringify(specialAssistOverridesByYear));
                localStorage.setItem(STORAGE_KEY_SOUVENIR_OVERRIDES, JSON.stringify(souvenirTravelOverridesByYear));
                localStorage.setItem(STORAGE_KEY_MANAGER_ROTATION_OVERRIDES, JSON.stringify(managerRotationOverridesByYear));
                localStorage.setItem(STORAGE_KEY_COMPANY_TRIP_FARE, companyTripBusFare);
            } catch (error) { console.error("Error saving data:", error); showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้'); }
        }

        // Saves all data and shows a success alert.
        function saveAllData() {
            saveDataToLocalStorage();
            showAlert('สำเร็จ', 'ข้อมูลทั้งหมดถูกบันทึกเรียบร้อยแล้ว');
        }

        // Initializes default budget data with empty values for a range of years.
        function initializeDefaultBudgetData() { return defaultBudgetItems.map(item => { if (item.type) return item; const newItem = { ...item, values: {} }; for (let year = 2568; year <= 2580; year++) { newItem.values[year] = 0; } return newItem; }); }
        
        // Loads all application data from local storage, or uses defaults if no data is found.
        function loadDataFromLocalStorage() {
            const savedBudgetString = localStorage.getItem(STORAGE_KEY_BUDGET);
            const savedEmployeeString = localStorage.getItem(STORAGE_KEY_EMPLOYEES);
            const savedAssist1String = localStorage.getItem(STORAGE_KEY_ASSIST1);
            const savedOvertimeString = localStorage.getItem(STORAGE_KEY_OVERTIME);
            const savedMasterRatesString = localStorage.getItem(STORAGE_KEY_MASTER_RATES);
            const savedAssistOverridesString = localStorage.getItem(STORAGE_KEY_ASSIST_OVERRIDES);
            const savedSouvenirOverridesString = localStorage.getItem(STORAGE_KEY_SOUVENIR_OVERRIDES);
            const savedManagerRotationOverridesString = localStorage.getItem(STORAGE_KEY_MANAGER_ROTATION_OVERRIDES);
            const savedCompanyTripFare = localStorage.getItem(STORAGE_KEY_COMPANY_TRIP_FARE);
            
            budgetData = savedBudgetString ? JSON.parse(savedBudgetString) : initializeDefaultBudgetData();
            employeeMasterData = savedEmployeeString ? JSON.parse(savedEmployeeString) : JSON.parse(JSON.stringify(defaultEmployeeMasterData));
            specialAssist1DataByYear = savedAssist1String ? JSON.parse(savedAssist1String) : {};
            overtimeDataByYear = savedOvertimeString ? JSON.parse(savedOvertimeString) : {};
            masterRates = savedMasterRatesString ? JSON.parse(savedMasterRatesString) : JSON.parse(JSON.stringify(defaultMasterRates));
            specialAssistOverridesByYear = savedAssistOverridesString ? JSON.parse(savedAssistOverridesString) : {};
            souvenirTravelOverridesByYear = savedSouvenirOverridesString ? JSON.parse(savedSouvenirOverridesString) : {};
            managerRotationOverridesByYear = savedManagerRotationOverridesString ? JSON.parse(savedManagerRotationOverridesString) : {};
            companyTripBusFare = savedCompanyTripFare ? parseFloat(savedCompanyTripFare) : 600;
        }

        // Resets all data in local storage and reloads the page.
        function resetAllData() { showConfirm('ยืนยันการล้างข้อมูล', 'คุณต้องการลบข้อมูลที่บันทึกไว้ทั้งหมดและกลับไปใช้ค่าเริ่มต้นใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้', () => { localStorage.removeItem(STORAGE_KEY_BUDGET); localStorage.removeItem(STORAGE_KEY_EMPLOYEES); localStorage.removeItem(STORAGE_KEY_ASSIST1); localStorage.removeItem(STORAGE_KEY_OVERTIME); localStorage.removeItem(STORAGE_KEY_MASTER_RATES); localStorage.removeItem(STORAGE_KEY_ASSIST_OVERRIDES); localStorage.removeItem(STORAGE_KEY_SOUVENIR_OVERRIDES); localStorage.removeItem(STORAGE_KEY_MANAGER_ROTATION_OVERRIDES); localStorage.removeItem(STORAGE_KEY_COMPANY_TRIP_FARE); showAlert('สำเร็จ', 'ข้อมูลทั้งหมดถูกล้างแล้ว กำลังโหลดหน้าใหม่...'); setTimeout(() => window.location.reload(), 1500); }); }
        
        // --- RENDER FUNCTIONS ---
        let draggedItemIndex = null; // Global variable to store the index of the dragged item

        // Renders the budget table based on current and next year selections.
        function renderBudgetTable() {
            const currentYear = document.getElementById('select-year-current').value;
            const nextYear = document.getElementById('select-year-next').value;
            
            const thead = document.getElementById("budget-table-head");
            thead.innerHTML = `
                <tr>
                    <th class="p-2 text-left w-[15%]">รหัสงบประมาณ</th>
                    <th class="p-2 text-left w-[15%]">รหัสบัญชี</th>
                    <th class="p-2 text-left w-[35%]">ชื่องบประมาณ/ชื่อบัญชี</th>
                    <th class="p-2 text-center border-l border-b-2" colspan="2">งบส่วนงาน</th>
                    <th class="p-2 text-center w-[15%] border-l">หมายเหตุ</th>
                    <th class="p-2 text-center w-[5%] no-print">จัดการ</th>
                </tr>
                <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th class="p-2 text-center font-semibold border-l w-[15%]">ปี${currentYear}</th>
                    <th class="p-2 text-center font-semibold w-[15%]">ปี${nextYear} - สิ้นสุดแผนงาน</th>
                    <th class="border-l"></th>
                    <th class="no-print"></th>
                </tr>
            `;

            const tbody = document.getElementById("budget-table-body-new");
            tbody.innerHTML = ""; 

            // Helper function to calculate section totals for main and sub-headers.
            const calculateSectionTotal = (startIndex, type) => {
                let totalCurrent = 0;
                let totalNext = 0;
                for (let i = startIndex + 1; i < budgetData.length; i++) {
                    const item = budgetData[i];
                    if (item.type === 'main_header' || (type === 'header' && item.type === 'header')) {
                        break;
                    }
                    if (item.code) {
                        totalCurrent += item.values[currentYear] || 0;
                        totalNext += item.values[nextYear] || 0;
                    }
                }
                return { totalCurrent, totalNext };
            };

            let grandTotalCurrent = 0;
            let grandTotalNext = 0;

            // Iterate through budget data to render rows or headers.
            budgetData.forEach((item, index) => {
                if (item.type === 'main_header' || item.type === 'header') {
                    const totals = calculateSectionTotal(index, item.type);
                     const headerClass = item.type === 'main_header' 
                        ? "bg-blue-600 text-white font-bold" 
                        : "bg-gray-200 font-semibold";
                    tbody.innerHTML += `
                        <tr class="${headerClass} budget-row" draggable="true" data-index="${index}">
                            <td colspan="3" class="px-4 py-2">${item.name}</td>
                            <td class="px-4 py-2 text-right">${formatCurrency(totals.totalCurrent)}</td>
                            <td class="px-4 py-2 text-right">${formatCurrency(totals.totalNext)}</td>
                            <td colspan="2"></td>
                        </tr>`;
                } else {
                    const currentValue = item.values[currentYear] || 0;
                    const nextValue = item.values[nextYear] || 0;
                    grandTotalCurrent += currentValue;
                    grandTotalNext += nextValue;
                    
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50 budget-row" draggable="true" data-index="${index}">
                            <td class="px-2 py-1"><input type="text" class="flat-input text-left" value="${item.budgetCode || ''}" onchange="updateBudgetItemDetails(${index}, 'budgetCode', this.value)"></td>
                            <td class="px-2 py-1"><input type="text" class="flat-input text-left" value="${item.code || ''}" onchange="updateBudgetItemDetails(${index}, 'code', this.value)"></td>
                            <td class="px-2 py-1"><input type="text" class="flat-input text-left" value="${item.name}" onchange="updateBudgetItemDetails(${index}, 'name', this.value)"></td>
                            <td class="px-2 py-1">
                                <input type="number" class="flat-input text-right" value="${currentValue}" onchange="updateBudget(${index}, ${currentYear}, this.value)">
                            </td>
                            <td class="px-2 py-1">
                                <input type="number" class="flat-input text-right" value="${nextValue}" onchange="updateBudget(${index}, ${nextYear}, this.value)">
                            </td>
                            <td class="px-2 py-1 border-l">
                                <input type="text" class="flat-input text-left" value="${item.notes || ''}" onchange="updateBudgetNotes(${index}, this.value)">
                            </td>
                            <td class="px-2 py-1 text-center no-print border-l">
                                <button onclick="confirmDeleteBudgetItem(${index})" class="text-red-400 hover:text-red-600 p-1">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1H4a1 1 0 000 2h1v9a2 2 0 002 2h6a2 2 0 002-2V6h1a1 1 0 100-2h-4V3a1 1 0 00-1-1H9zm7 2h-2v10a1 1 0 01-1 1H7a1 1 0 01-1-1V4H4a1 1 0 110-2h12a1 1 0 110 2z" clip-rule="evenodd" /></svg>
                                </button>
                            </td>
                        </tr>`;
                }
            });

            // Add drag and drop event listeners to the newly rendered rows
            document.querySelectorAll('#budget-table-body-new .budget-row').forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('dragend', handleDragEnd);
            });

            // Update grand total display
            document.getElementById('grand-total-current').textContent = formatCurrency(grandTotalCurrent);
            document.getElementById('grand-total-next').textContent = formatCurrency(grandTotalNext);
        }

        // Handles the start of a drag operation.
        function handleDragStart(event) {
            draggedItemIndex = event.target.dataset.index;
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }

        // Allows a drop to happen by preventing the default handling of the element.
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        // Handles a dragged element entering a valid drop target.
        function handleDragEnter(event) {
            event.preventDefault();
            const targetRow = event.target.closest('.budget-row');
            if (targetRow) {
                targetRow.classList.add('drag-over');
            }
        }

        // Handles a dragged element leaving a valid drop target.
        function handleDragLeave(event) {
            const targetRow = event.target.closest('.budget-row');
            if (targetRow) {
                targetRow.classList.remove('drag-over');
            }
        }

        // Handles a drop operation.
        function handleDrop(event) {
            event.preventDefault();
            const targetRow = event.target.closest('.budget-row');
            if (!targetRow) return;

            targetRow.classList.remove('drag-over');

            const dropIndex = parseInt(targetRow.dataset.index);
            const draggedIndex = parseInt(draggedItemIndex);

            if (draggedIndex === dropIndex) return;

            // Remove the dragged item from its original position
            const [draggedItem] = budgetData.splice(draggedIndex, 1);
            // Insert the dragged item at the new position
            budgetData.splice(dropIndex, 0, draggedItem);

            saveDataToLocalStorage();
            renderBudgetTable(); // Re-render the table to reflect the new order
        }

        // Handles the end of a drag operation.
        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            // Remove drag-over class from all rows in case it was left on
            document.querySelectorAll('.budget-row').forEach(row => row.classList.remove('drag-over'));
            draggedItemIndex = null; // Reset the dragged item index
        }


        // Updates budget item details (budgetCode, code, name) and saves data.
        window.updateBudgetItemDetails = (index, key, value) => {
            budgetData[index][key] = value;
            saveDataToLocalStorage();
        };

        // Adds a new budget item to the table.
        window.addBudgetItem = () => {
            const newRow = { budgetCode: '', code: '', name: 'รายการใหม่', notes: '', values: {} };
            const currentYear = document.getElementById('select-year-current').value;
            const nextYear = document.getElementById('select-year-next').value;
            newRow.values[currentYear] = 0;
            newRow.values[nextYear] = 0;
            
            // Determine the insertion index to keep headers grouped
            let insertIndex = budgetData.length;
            for(let i = budgetData.length - 1; i >= 0; i--) {
                if(budgetData[i].type === 'header') {
                    insertIndex = i + 1;
                    for(let j = insertIndex; j < budgetData.length; j++) {
                        if(budgetData[j].type) {
                            insertIndex = j;
                            break;
                        }
                    }
                    break;
                }
            }
            budgetData.splice(insertIndex, 0, newRow);
            renderBudgetTable();
        };

        // Confirms and deletes a budget item.
        window.confirmDeleteBudgetItem = (index) => {
            const itemName = budgetData[index].name || 'รายการที่เลือก';
            showConfirm('ยืนยันการลบ', `คุณต้องการลบรายการ "${itemName}" ใช่หรือไม่?`, () => {
                budgetData.splice(index, 1);
                saveDataToLocalStorage();
                renderBudgetTable();
            });
        };

        // Updates a budget value for a specific year and re-renders the table.
        window.updateBudget = (index, year, value) => {
            budgetData[index].values[year] = parseFloat(value) || 0;
            renderBudgetTable();
            saveDataToLocalStorage();
        };
        
        // Updates notes for a budget item.
        window.updateBudgetNotes = (index, value) => {
            budgetData[index].notes = value;
            saveDataToLocalStorage();
        };

        // Renders the master rates table.
        function renderMasterRatesTable() {
            const table = document.getElementById('master-rates-table');
            const rateKeys = { rent: 'ค่าเช่าบ้าน', monthlyAssist: 'เงินช่วยเหลือรายเดือน', lumpSum: 'ค่าซื้อของเหมาจ่าย', travel: 'ค่ารถประจำทาง/เที่ยว', local: 'ค่ารถรับจ้าง/เที่ยว', perDiem: 'ค่าเบี้ยเลี้ยง', hotel: 'ค่าที่พัก' };
            let thead = `<thead><tr class="bg-gray-100"><th class="px-4 py-2">ตำแหน่ง</th><th class="px-4 py-2">ระดับ</th>${Object.values(rateKeys).map(val => `<th class="px-4 py-2 text-right">${val}</th>`).join('')}</tr></thead>`;
            let tbody = '<tbody>';
            const sortedLevels = Object.keys(masterRates).sort((a, b) => parseFloat(b) - parseFloat(a));
            sortedLevels.forEach(level => { const data = masterRates[level]; tbody += `<tr class="border-b"><td class="p-1"><input type="text" class="w-full p-1 border rounded" value="${data.position}" onchange="updateMasterRate('${level}', 'position', this.value)"></td><td class="px-4 py-2 text-center">${level}</td>${Object.keys(rateKeys).map(key => `<td class="p-1"><input type="number" class="w-full p-1 border rounded text-right" value="${data[key]}" onchange="updateMasterRate('${level}', '${key}', this.value)"></td>`).join('')}</tr>`; });
            tbody += '</tbody>';
            table.innerHTML = thead + tbody;
        }

        // Updates a master rate value and saves data.
        window.updateMasterRate = (level, key, value) => { const isNumeric = key !== 'position'; masterRates[level][key] = isNumeric ? (parseFloat(value) || 0) : value; saveDataToLocalStorage(); };

        // Renders the employee list table.
        function renderEmployeeListTable() {
            const tbody = document.getElementById("employee-list-body");
            tbody.innerHTML = "";
            if (employeeMasterData.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-8">ไม่มีข้อมูลพนักงาน</td></tr>'; return; }
            const levelOptions = Object.keys(masterRates).sort((a, b) => parseFloat(b) - parseFloat(a));
            employeeMasterData.forEach((emp, index) => {
                let levelDropdown = `<select class="w-full p-1 border rounded bg-white" onchange="updateEmployee(${index}, 'level', this.value)">${levelOptions.map(lvl => `<option value="${lvl}" ${emp.level == lvl ? 'selected' : ''}>${lvl}</option>`).join('')}</select>`;
                tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-1"><input type="text" class="w-full p-1 border rounded" value="${emp.id}" onchange="updateEmployee(${index}, 'id', this.value)"></td><td class="p-1"><input type="text" class="w-full p-1 border rounded" value="${emp.name}" onchange="updateEmployee(${index}, 'name', this.value)"></td><td class="p-1"><select class="w-full p-1 border rounded bg-white" onchange="updateEmployee(${index}, 'status', this.value)"><option value="Active" ${emp.status === 'Active' ? 'selected' : ''}>Active</option><option value="Inactive" ${emp.status === 'Inactive' ? 'selected' : ''}>Inactive</option></select></td><td class="p-1 text-center"><input type="text" class="w-full p-1 border rounded text-center" value="${emp.gender}" onchange="updateEmployee(${index}, 'gender', this.value)"></td><td class="p-1"><input type="number" class="w-full p-1 border rounded text-center" value="${emp.startYear}" onchange="updateEmployee(${index}, 'startYear', this.value)"></td><td class="p-1">${levelDropdown}</td><td class="p-1"><input type="text" class="w-full p-1 border rounded" value="${emp.visitProvince}" onchange="updateEmployee(${index}, 'visitProvince', this.value)"></td><td class="p-1"><input type="number" class="w-full p-1 border rounded text-right" value="${emp.homeVisitBusFare}" onchange="updateEmployee(${index}, 'homeVisitBusFare', this.value)"></td><td class="p-1 text-center"><button onclick="confirmDeleteEmployee(${index})" class="text-red-500 hover:text-red-700 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td></tr>`;
            });
        }

        // Gets the master rates for a given employee level.
        function getRatesForEmployee(emp) { const defaultRates = { position: 'ไม่ระบุ', rent: 0, monthlyAssist: 0, lumpSum: 0, travel: 0, local: 0, perDiem: 0, hotel: 0 }; return masterRates[emp.level] || defaultRates; }
        // Updates employee data and re-renders the list.
        window.updateEmployee = (index, key, value) => { const isNumeric = ['startYear', 'homeVisitBusFare'].includes(key); employeeMasterData[index][key] = isNumeric ? (parseFloat(value) || 0) : value; renderEmployeeListTable(); saveDataToLocalStorage(); };
        // Adds a new empty employee to the list.
        window.addEmployee = () => { employeeMasterData.unshift({ id: '', name: '', gender: 'ชาย', startYear: new Date().getFullYear() + 543, level: '3', visitProvince: '', homeVisitBusFare: 0, status: 'Active' }); renderEmployeeListTable(); saveDataToLocalStorage(); };
        // Confirms and deletes an employee.
        window.confirmDeleteEmployee = (index) => { const empName = employeeMasterData[index].name || 'พนักงานใหม่'; showConfirm('ยืนยันการลบ', `คุณต้องการลบข้อมูลของ '${empName}' ใช่หรือไม่?`, () => { employeeMasterData.splice(index, 1); renderEmployeeListTable(); saveDataToLocalStorage(); }); };
        
        // --- CALCULATION & RENDER (Grouped Views) ---
        // Renders all travel-related sub-sections.
        function renderTravelGroup() {
            // These functions are now called directly by switchTravelSubView
            // calculateAndRenderTravelSouvenir();
            // calculateAndRenderFamilyVisit();
            // calculateAndRenderCompanyTrip();
            // calculateAndRenderManagerRotation();

            // Initialize the first tab content
            switchTravelSubView(activeTravelTab);
        }

        // Renders all assistance-related sub-sections and switches to the specified sub-view.
        function renderAssistanceGroup(subView = 'assist-other') {
            document.getElementById('display-assist-group-year').textContent = assistGroupCalcYear;
            calculateAndRenderSpecialAssist();
            calculateAndRenderSpecialAssist1();
            calculateAndRenderOvertime();
            switchSubView('assistance', subView);
        }

        // --- CALCULATION & RENDER (Individual Components) ---
        // Updates souvenir travel employee data and re-calculates.
        window.updateSouvenirTravelEmployee = (index, key, value) => {
            const empId = calculatedTravelEmployees[index].id;
            if (!souvenirTravelOverridesByYear[travelCalcYear]) {
                souvenirTravelOverridesByYear[travelCalcYear] = {};
            }
            if (!souvenirTravelOverridesByYear[travelCalcYear][empId]) {
                souvenirTravelOverridesByYear[travelCalcYear][empId] = {};
            }
            souvenirTravelOverridesByYear[travelCalcYear][empId][key] = Math.max(1, parseInt(value) || 1); // Ensure at least 1 day
            saveDataToLocalStorage();
            calculateAndRenderTravelSouvenir();
        };

        // Calculates and renders souvenir travel expenses.
        function calculateAndRenderTravelSouvenir() {
            document.getElementById('display-travel-year-souvenir').textContent = travelCalcYear; // Update specific year display
            const tbody = document.getElementById("travel-employee-list");
            const eligibleServiceYears = [20, 25, 30, 35, 40]; // Years of service eligible for souvenir travel
            const overrides = souvenirTravelOverridesByYear[travelCalcYear] || {};

            calculatedTravelEmployees = employeeMasterData
                .filter(e => e.status === 'Active')
                .map(e => ({ ...e, serviceYears: travelCalcYear - e.startYear }))
                .filter(e => eligibleServiceYears.includes(e.serviceYears))
                .map(emp => {
                    const empOverride = overrides[emp.id] || {};
                    const scheduledDays = empOverride.scheduledDays !== undefined ? empOverride.scheduledDays : 1; // Use override or default 1 day
                    
                    const rates = getRatesForEmployee(emp);
                    const hotelDays = 2 + (scheduledDays - 1); // 2 fixed days + additional scheduled days
                    const perDiemDays = 3 + (scheduledDays - 1); // 3 fixed days + additional scheduled days

                    const hotelCost = (rates.hotel || 0) * hotelDays;
                    const perDiemCost = (rates.perDiem || 0) * perDiemDays;
                    const travelCost = (rates.travel || 0) * 2; // Fixed 2 trips
                    const localCost = (rates.local || 0) * 2;   // Fixed 2 trips
                    const total = hotelCost + perDiemCost + travelCost + localCost;

                    return { ...emp, scheduledDays, hotelCost, perDiemCost, travelCost, localCost, total, rates, hotelDays, perDiemDays };
                });

            tbody.innerHTML = "";
            if (calculatedTravelEmployees.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-8">ไม่พบพนักงานที่เข้าเกณฑ์สำหรับปี พ.ศ. ${travelCalcYear}</td></tr>`;
            } else {
                calculatedTravelEmployees.forEach((emp, index) => {
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-medium">${emp.name}</td>
                            <td class="px-4 py-2 text-center">${emp.serviceYears}</td>
                            <td class="p-1 text-center">
                                <input type="number" class="w-20 p-1 border rounded text-center" value="${emp.scheduledDays}" onchange="updateSouvenirTravelEmployee(${index}, 'scheduledDays', this.value)">
                            </td>
                            <td class="px-4 py-2 text-right">
                                <div>${formatCurrency(emp.hotelCost)}</div>
                            </td>
                            <td class="px-4 py-2 text-right">
                                <div>${formatCurrency(emp.perDiemCost)}</div>
                            </td>
                            <td class="px-4 py-2 text-right">
                                <div>${formatCurrency(emp.travelCost)}</div>
                            </td>
                            <td class="px-4 py-2 text-right">
                                <div>${formatCurrency(emp.localCost)}</div>
                            </td>
                            <td class="px-4 py-2 text-right font-bold">${formatCurrency(emp.total)}</td>
                        </tr>`;
                });
            }
            document.getElementById("travel-total-cost").textContent = `${formatCurrency(calculatedTravelEmployees.reduce((s, e) => s + e.total, 0))} บาท`;
        }
        
        function calculateAndRenderFamilyVisit() {
            document.getElementById('display-family-visit-year-family').textContent = familyVisitCalcYear; // Update specific year display
            const tbody = document.getElementById("family-visit-list");
            
            calculatedFamilyVisitData = employeeMasterData
                .filter(emp => emp.status === 'Active')
                .map(emp => ({
                    ...emp,
                    total: 4 * (emp.homeVisitBusFare || 0) * 2 // 4 times a year, 2 trips per time
                }));

            tbody.innerHTML = "";
            if (calculatedFamilyVisitData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-8">ไม่พบพนักงานที่มีสถานะ Active</td></tr>';
            } else {
                calculatedFamilyVisitData.forEach(emp => {
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="px-4 py-2">${emp.id}</td>
                            <td class="px-4 py-2">${emp.name}</td>
                            <td class="px-4 py-2">${emp.visitProvince || '-'}</td>
                            <td class="px-4 py-2 text-right">
                                <div>${formatCurrency(emp.total)}</div>
                            </td>
                            <td class="px-4 py-2 text-right font-bold">${formatCurrency(emp.total)}</td>
                        </tr>`;
                });
            }
            document.getElementById("family-visit-total").textContent = `${formatCurrency(calculatedFamilyVisitData.reduce((s, e) => s + e.total, 0))} บาท`;
        }
        
        window.updateCompanyTripFare = (value) => {
            companyTripBusFare = parseFloat(value) || 0;
            saveDataToLocalStorage();
            calculateAndRenderCompanyTrip();
        }

        function calculateAndRenderCompanyTrip() {
            // No specific year display for company trip, as it uses global companyTripBusFare
            document.getElementById('company-trip-bus-fare').value = companyTripBusFare;
            const tbody = document.getElementById("company-trip-list");
            
            let finalTripList = [];

            const level7Emps = employeeMasterData.filter(emp => emp.level === '7');
            level7Emps.forEach(emp => {
                const rates = getRatesForEmployee(emp);
                const accommodationCost = rates.hotel || 0;
                finalTripList.push({
                    ...emp,
                    busFare: companyTripBusFare,
                    accommodationCost,
                    total: companyTripBusFare + accommodationCost,
                    note: 'พักเดี่ยว (ระดับ 7)'
                });
            });

            const nonLevel7Emps = employeeMasterData.filter(emp => emp.level !== '7');
            const khonKaenGroup = nonLevel7Emps.filter(emp => emp.visitProvince === 'ขอนแก่น');
            khonKaenGroup.forEach(emp => {
                finalTripList.push({
                    ...emp,
                    busFare: companyTripBusFare,
                    accommodationCost: 0,
                    total: companyTripBusFare,
                    note: 'ภูมิลำเนาขอนแก่น (ไม่มีค่าที่พัก)'
                });
            });
            
            const otherGroup = nonLevel7Emps.filter(emp => emp.visitProvince !== 'ขอนแก่น');
            const maleSharers = otherGroup.filter(e => e.gender === 'ชาย').sort((a, b) => getRatesForEmployee(b).hotel - getRatesForEmployee(a).hotel);
            const femaleSharers = otherGroup.filter(e => e.gender === 'หญิง').sort((a, b) => getRatesForEmployee(b).hotel - getRatesForEmployee(a).hotel);

            const processSharingGroup = (group) => {
                for (let i = 0; i < group.length; i += 2) {
                    const emp1 = group[i];
                    const emp2 = group[i + 1];

                    if (emp2) {
                        const roomCost = Math.max(getRatesForEmployee(emp1).hotel, getRatesForEmployee(emp2).hotel);
                        const costPerPerson = roomCost / 2;
                        finalTripList.push({ ...emp1, busFare: companyTripBusFare, accommodationCost: costPerPerson, total: companyTripBusFare + costPerPerson, note: `หารค่าห้องกับ ${emp2.name} (ห้องละ ${formatCurrency(roomCost)})` });
                        finalTripList.push({ ...emp2, busFare: companyTripBusFare, accommodationCost: costPerPerson, total: companyTripBusFare + costPerPerson, note: `หารค่าห้องกับ ${emp1.name} (ห้องละ ${formatCurrency(roomCost)})` });
                    } else {
                        const accommodationCost = getRatesForEmployee(emp1).hotel || 0;
                        finalTripList.push({ ...emp1, busFare: companyTripBusFare, accommodationCost, total: companyTripBusFare + accommodationCost, note: 'พักเดี่ยว (ไม่มีคู่)' });
                    }
                }
            };

            processSharingGroup(maleSharers);
            processSharingGroup(femaleSharers);

            finalTripList.sort((a, b) => employeeMasterData.findIndex(e => e.id === a.id) - employeeMasterData.findIndex(e => e.id === b.id));
            
            tbody.innerHTML = "";
            if (finalTripList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">ไม่มีข้อมูลพนักงาน</td></tr>';
            } else {
                finalTripList.forEach(emp => {
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-medium">${emp.name}</td>
                            <td class="px-4 py-2 text-right">
                                <div>${formatCurrency(emp.busFare)}</div>
                            </td>
                            <td class="px-4 py-2 text-right">
                                <div>${formatCurrency(emp.accommodationCost)}</div>
                            </td>
                            <td class="px-4 py-2 text-right font-bold">${formatCurrency(emp.total)}</td>
                        </tr>`;
                });
            }
            document.getElementById("company-trip-total").textContent = `${formatCurrency(finalTripList.reduce((s, e) => s + e.total, 0))} บาท`;
            calculatedCompanyTripTotalValue = finalTripList.reduce((s, e) => s + e.total, 0); // Store the total
        }

        window.updateManagerRotationEmployee = (index, key, value) => {
            const empId = calculatedManagerRotationData[index].id;
             if (!managerRotationOverridesByYear[managerRotationCalcYear]) {
                managerRotationOverridesByYear[managerRotationCalcYear] = {};
            }
            if (!managerRotationOverridesByYear[managerRotationCalcYear][empId]) {
                managerRotationOverridesByYear[managerRotationCalcYear][empId] = {};
            }
            managerRotationOverridesByYear[managerRotationCalcYear][empId][key] = parseFloat(value) || 0;
            saveDataToLocalStorage();
            calculateAndRenderManagerRotation();
        };
        
        function calculateAndRenderManagerRotation() {
            document.getElementById('display-manager-rotation-year-manager').textContent = managerRotationCalcYear; // Update specific year display
            const tbody = document.getElementById("manager-rotation-list");
            const overrides = managerRotationOverridesByYear[managerRotationCalcYear] || {};
            
            calculatedManagerRotationData = employeeMasterData
                .filter(e => e.status === 'Active' && e.level === '7')
                .map(emp => {
                    const rates = getRatesForEmployee(emp);
                    const empOverride = overrides[emp.id] || {};
                    
                    const perDiemCost = (rates.perDiem || 0) * 7;
                    const accommodationCost = (rates.hotel || 0) * 6;
                    const fixedTravelCost = 5600;
                    const otherVehicleCost = empOverride.otherVehicleCost || 0;
                    
                    const total = perDiemCost + accommodationCost + fixedTravelCost + otherVehicleCost;
                    
                    return { ...emp, perDiemCost, accommodationCost, fixedTravelCost, otherVehicleCost, total, rates };
                });

            tbody.innerHTML = "";
            if (calculatedManagerRotationData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">ไม่พบพนักงานระดับ 7 ที่มีสถานะ Active</td></tr>';
            } else {
                calculatedManagerRotationData.forEach((emp, index) => {
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-medium">${emp.name}</td>
                            <td class="px-4 py-2 text-right"><div>${formatCurrency(emp.perDiemCost)}</div></td>
                            <td class="px-4 py-2 text-right"><div>${formatCurrency(emp.accommodationCost)}</div></td>
                            <td class="px-4 py-2 text-right"><div>${formatCurrency(emp.fixedTravelCost)}</div></td>
                            <td class="p-1 text-right">
                                <input type="number" class="w-24 p-1 border rounded text-right" value="${emp.otherVehicleCost}" onchange="updateManagerRotationEmployee(${index}, 'otherVehicleCost', this.value)">
                            </td>
                            <td class="px-4 py-2 text-right font-bold">${formatCurrency(emp.total)}</td>
                        </tr>`;
                });
            }
            document.getElementById("manager-rotation-total").textContent = `${formatCurrency(calculatedManagerRotationData.reduce((s, e) => s + e.total, 0))} บาท`;
        }
        
        window.updateSpecialAssistEmployee = (index, key, value) => {
            const empId = calculatedSpecialAssistData[index].id;
            if (!specialAssistOverridesByYear[assistGroupCalcYear]) {
                specialAssistOverridesByYear[assistGroupCalcYear] = {};
            }
            if (!specialAssistOverridesByYear[assistGroupCalcYear][empId]) {
                specialAssistOverridesByYear[assistGroupCalcYear][empId] = {};
            }
            specialAssistOverridesByYear[assistGroupCalcYear][empId][key] = parseFloat(value) || 0;
            saveDataToLocalStorage();
            renderAssistanceGroup('assist-other');
        };

        function calculateAndRenderSpecialAssist() {
            const tbody = document.getElementById("special-assist-list");
            const overrides = specialAssistOverridesByYear[assistGroupCalcYear] || {};

            calculatedSpecialAssistData = employeeMasterData.filter(e => e.status === 'Active').map(emp => {
                const rates = getRatesForEmployee(emp);
                const empOverride = overrides[emp.id] || {};

                const assistMonths = empOverride.assistMonths !== undefined ? empOverride.assistMonths : 12;
                const lumpSum = empOverride.lumpSum !== undefined ? empOverride.lumpSum : 0;
                
                const totalRent = (rates.rent || 0) * 12;
                const totalMonthlyAssist = (rates.monthlyAssist || 0) * assistMonths;
                const total = totalRent + totalMonthlyAssist + lumpSum;
                
                return { ...emp, totalRent, totalMonthlyAssist, lumpSum, total, assistMonths };
            }).filter(e => e.total > 0 || (getRatesForEmployee(e).rent > 0 || getRatesForEmployee(e).monthlyAssist > 0));

            tbody.innerHTML = "";
            if (calculatedSpecialAssistData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-8">ไม่มีข้อมูล</td></tr>';
            } else {
                calculatedSpecialAssistData.forEach((emp, index) => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-600">${emp.id}</td>
                            <td class="px-4 py-2 font-medium">${emp.name}</td>
                            <td class="px-4 py-2 text-right">${formatCurrency(emp.totalRent)}</td>
                            <td class="p-1 text-center">
                                <input type="number" class="w-20 p-1 border rounded text-center" value="${emp.assistMonths}" onchange="updateSpecialAssistEmployee(${index}, 'assistMonths', this.value)">
                            </td>
                            <td class="px-4 py-2 text-right">${formatCurrency(emp.totalMonthlyAssist)}</td>
                            <td class="p-1 text-right">
                                <input type="number" class="w-24 p-1 border rounded text-right" value="${emp.lumpSum}" onchange="updateSpecialAssistEmployee(${index}, 'lumpSum', this.value)">
                            </td>
                            <td class="px-4 py-2 text-right font-bold">${formatCurrency(emp.total)}</td>
                        </tr>`;
                });
            }
            document.getElementById("special-assist-total").textContent = `${formatCurrency(calculatedSpecialAssistData.reduce((s, i) => s + i.total, 0))} บาท`;
        }

        function getSpecialAssist1DataForYear(year) { if (!specialAssist1DataByYear[year]) { specialAssist1DataByYear[year] = { items: JSON.parse(JSON.stringify(defaultSpecialAssist1Data)), notes: '' }; } return specialAssist1DataByYear[year]; }
        
        function calculateAndRenderSpecialAssist1() {
            const tbody = document.getElementById("special-assist-1-list");
            const currentYearData = getSpecialAssist1DataForYear(assistGroupCalcYear);
            let total = 0;
            tbody.innerHTML = "";
            currentYearData.items.forEach((item, index) => { const amount = item.timesPerYear * item.days * item.people * item.rate; total += amount; tbody.innerHTML += `<tr class="border-b"><td class="p-2"><input type="text" class="w-full p-1 border rounded" value="${item.item}" onchange="updateSpecialAssist1Item(${index}, 'item', this.value)"></td><td class="p-2"><input type="number" class="w-20 p-1 border rounded text-center" value="${item.timesPerYear}" onchange="updateSpecialAssist1Item(${index}, 'timesPerYear', this.value)"></td><td class="p-2"><input type="number" class="w-20 p-1 border rounded text-center" value="${item.days}" onchange="updateSpecialAssist1Item(${index}, 'days', this.value)"></td><td class="p-2"><input type="number" class="w-20 p-1 border rounded text-center" value="${item.people}" onchange="updateSpecialAssist1Item(${index}, 'people', this.value)"></td><td class="p-2"><input type="number" class="w-24 p-1 border rounded text-right" value="${item.rate}" onchange="updateSpecialAssist1Item(${index}, 'rate', this.value)"></td><td class="p-2 text-right">${formatCurrency(amount)}</td></tr>`; });
            document.getElementById("special-assist-1-total").textContent = formatCurrency(total);
            document.getElementById('special-assist-1-notes').value = currentYearData.notes || '';
        }

        window.updateSpecialAssist1Item = (index, key, value) => { const d = getSpecialAssist1DataForYear(assistGroupCalcYear); const isNum = key !== 'item'; d.items[index][key] = isNum ? (parseFloat(value) || 0) : value; calculateAndRenderSpecialAssist1(); saveDataToLocalStorage(); };
        window.updateSpecialAssist1Notes = (value) => { getSpecialAssist1DataForYear(assistGroupCalcYear).notes = value; saveDataToLocalStorage(); };

        function getOvertimeDataForYear(year) { if (!overtimeDataByYear[year]) { const refY = year - 1, refYCE = refY - 543; const refH = holidaysByYear[refYCE] || []; let counts = { 3: 0, 4: 0, 5: 0 }; if (refH.length > 0) { let cons = 0; for (let i = 0; i < refH.length; i++) { const curr = new Date(refH[i].date + 'T00:00:00').getTime(), prev = i > 0 ? new Date(refH[i-1].date + 'T00:00:00').getTime() : 0; if (i > 0 && (curr - prev) / 864e5 === 1) { cons++; } else { if (cons >= 3 && cons <= 5) counts[cons]++; cons = 1; } } if (cons >= 3 && cons <= 5) counts[cons]++; } overtimeDataByYear[year] = { salary: 15000, items: [ { item: 'วันหยุดยาว 3 วัน', days: 3, instances: counts[3], hours: 8, people: 1 }, { item: 'วันหยุดยาว 4 วัน', days: 4, instances: counts[4], hours: 8, people: 1 }, { item: 'วันหยุดยาว 5 วัน', days: 5, instances: counts[5], hours: 8, people: 1 }, ] }; } return overtimeDataByYear[year]; }
        
        function calculateAndRenderOvertime() {
            const tbody = document.getElementById("overtime-list");
            const currentYearData = getOvertimeDataForYear(assistGroupCalcYear);
            document.getElementById('overtime-salary').value = currentYearData.salary;
            const hourlyRate = currentYearData.salary / 210;
            let total = 0;
            tbody.innerHTML = "";
            currentYearData.items.forEach((item, index) => { const rate = item.rate === undefined ? hourlyRate : item.rate; const amount = item.instances * item.days * item.hours * item.people * rate; total += amount; tbody.innerHTML += `<tr class="border-b"><td class="p-2"><input type="text" class="w-full p-1 border rounded" value="${item.item}" onchange="updateOvertimeData('items', ${index}, 'item', this.value)"></td><td class="p-2"><input type="number" class="w-20 p-1 border rounded text-center" value="${item.instances}" onchange="updateOvertimeData('items', ${index}, 'instances', this.value)"></td><td class="p-2"><input type="number" class="w-24 p-1 border rounded text-center" value="${item.hours}" onchange="updateOvertimeData('items', ${index}, 'hours', this.value)"></td><td class="p-2"><input type="number" class="w-24 p-1 border rounded text-center" value="${item.people}" onchange="updateOvertimeData('items', ${index}, 'people', this.value)"></td><td class="p-2"><input type="number" class="w-24 p-1 border rounded text-right" value="${rate.toFixed(2)}" onchange="updateOvertimeData('items', ${index}, 'rate', this.value)"></td><td class="p-2 text-right">${formatCurrency(amount)}</td></tr>`; });
            document.getElementById("overtime-total").textContent = formatCurrency(total);
        }

        window.updateOvertimeData = (field, indexOrValue, key, value) => { const d = getOvertimeDataForYear(assistGroupCalcYear); if (field === 'salary') { d.salary = parseFloat(indexOrValue) || 0; } else if (field === 'items') { const isNum = key !== 'item'; d.items[indexOrValue][key] = isNum ? (parseFloat(value) || 0) : value; } calculateAndRenderOvertime(); saveDataToLocalStorage(); };

        function calculateWorkDays() {
            document.getElementById('display-workday-year').textContent = workdayCalcYear;
            const yearBE = workdayCalcYear, yearCE = yearBE - 543;
            const resultsContainer = document.getElementById('workday-results-container');
            const managementContainer = document.getElementById('holiday-management-container');
            let weekdays = 0;
            for (let m = 0; m < 12; m++) { const daysInMonth = new Date(yearCE, m + 1, 0).getDate(); for (let d = 1; d <= daysInMonth; d++) { const dayOfWeek = new Date(yearCE, m, d).getDay(); if (dayOfWeek > 0 && dayOfWeek < 6) weekdays++; } }
            if (holidaysByYear[yearCE]) {
                managementContainer.classList.remove('hidden');
                renderHolidayEditor(yearCE);
                let holidaysOnWeekdays = 0;
                (holidaysByYear[yearCE] || []).forEach(h => { const d = new Date(h.date + 'T00:00:00'); if (d.getDay() > 0 && d.getDay() < 6) { holidaysOnWeekdays++; } });
                const totalWorkDays = weekdays - holidaysOnWeekdays;
                resultsContainer.innerHTML = `<div class="bg-indigo-50 p-4 rounded-lg space-y-3"><h3 class="text-xl font-bold text-indigo-800">สรุปวันทำงานปี พ.ศ. ${yearBE}</h3><div class="grid grid-cols-2 gap-2 text-base"><span class="font-semibold">วันทำงาน (จ-ศ):</span> <span class="text-right">${weekdays} วัน</span><span class="font-semibold">วันหยุดในวันทำงาน:</span> <span class="text-right text-red-600">-${holidaysOnWeekdays} วัน</span></div><div class="border-t pt-3 mt-3 flex justify-between items-center text-xl font-bold"><span>สรุปวันทำงานจริง:</span><span class="text-indigo-700">${totalWorkDays} วัน</span></div></div>`;
            } else {
                managementContainer.classList.add('hidden');
                const availableYears = Object.keys(holidaysByYear).map(Number).sort((a, b) => b - a);
                const recentYears = availableYears.slice(0, 5);
                if (recentYears.length === 0) { resultsContainer.innerHTML = `<div class="bg-red-50 p-4 rounded-lg"><p class="text-center text-red-700">ไม่มีข้อมูลวันหยุดย้อนหลัง</p></div>`; return; }
                const avgHolidays = Math.round(recentYears.map(y => holidaysByYear[y].length).reduce((s, c) => s + c, 0) / recentYears.length);
                resultsContainer.innerHTML = `<div class="bg-yellow-50 p-4 rounded-lg space-y-3"><h3 class="text-xl font-bold text-yellow-800">ประมาณการปี ${yearBE}</h3><p class="text-sm text-yellow-700">คำนวณจากค่าเฉลี่ย 5 ปีย้อนหลัง</p><div class="grid grid-cols-2 gap-2 text-base"><span class="font-semibold">วันทำงาน (จ-ศ):</span> <span class="text-right">${weekdays} วัน</span><span class="font-semibold">ประมาณการวันหยุด:</span> <span class="text-right text-red-600">-${avgHolidays} วัน</span></div><div class="border-t pt-3 mt-3 flex justify-between items-center text-xl font-bold"><span>ประมาณการวันทำงานจริง:</span><span class="text-yellow-700">${weekdays - avgHolidays} วัน</span></div></div>`;
            }
        }

        function renderHolidayEditor(yearCE) {
            const editor = document.getElementById('holiday-list-editor');
            if (!holidaysByYear[yearCE]) { holidaysByYear[yearCE] = []; }
            const holidays = holidaysByYear[yearCE] || [];
            if (holidays.length === 0) { editor.innerHTML = '<p class="text-center text-gray-500">ไม่มีข้อมูลวันหยุด</p>'; return; }
            editor.innerHTML = `<ul class="space-y-2">${holidays.map((h, i) => `<li class="flex items-center justify-between bg-white p-2 rounded-md shadow-sm"><div><span class="font-semibold">${new Date(h.date).toLocaleDateString('th-TH')}</span><span class="text-gray-600 ml-2">${h.name}</span></div><button onclick="deleteHoliday(${yearCE}, ${i})" class="text-red-500 hover:text-red-700 p-1">&times;</button></li>`).join('')}</ul>`;
        }
        window.deleteHoliday = (yearCE, index) => { holidaysByYear[yearCE].splice(index, 1); calculateWorkDays(); };
        window.addHoliday = (yearCE) => { const d = document.getElementById("new-holiday-date"), n = document.getElementById("new-holiday-name"); if (!d.value || !n.value) return showAlert("ข้อมูลไม่ครบ", "กรุณาระบุวันที่และชื่อวันหยุด"); if (!holidaysByYear[yearCE]) holidaysByYear[yearCE] = []; holidaysByYear[yearCE].push({ date: d.value, name: n.value }); holidaysByYear[yearCE].sort((a, b) => new Date(a.date) - new Date(b.date)); d.value = ""; n.value = ""; calculateWorkDays(); };

        function renderKpiCards(subView) {
            const container = document.getElementById('kpi-cards-container');
            let cards = '';
            let data, total, count;

            const createCard = (value, label, color) => `<div class="bg-gray-50 rounded-lg p-4 text-center shadow-sm border-l-4 border-${color}-500"><p class="text-2xl font-bold text-gray-800">${value}</p><p class="text-sm text-gray-500">${label}</p></div>`;

            if (subView === 'assist-other') {
                const data = calculatedSpecialAssistData;
                const count = data.length;
                const totalRent = data.reduce((s, i) => s + i.totalRent, 0);
                const totalMonthlyAssist = data.reduce((s, i) => s + i.totalMonthlyAssist, 0);
                const grandTotal = data.reduce((s, i) => s + i.total, 0);

                cards += createCard(count, 'พนักงานที่มีสิทธิ์', 'indigo');
                cards += createCard(formatCurrency(totalRent), 'รวมค่าเช่า', 'green');
                cards += createCard(formatCurrency(totalMonthlyAssist), 'รวมเงินช่วยเหลือ', 'violet');
                cards += createCard(formatCurrency(grandTotal), 'ยอดรวมทั้งหมด', 'amber');

            } else if (subView === 'assist-special') {
                const currentData = getSpecialAssist1DataForYear(assistGroupCalcYear);
                total = currentData.items.reduce((s, i) => s + (i.timesPerYear * i.days * i.people * i.rate), 0);
                cards += createCard(currentData.items.length, 'รายการ', 'indigo');
                cards += createCard(formatCurrency(total), 'ยอดรวมทั้งหมด', 'green');
                cards += createCard('-', 'เฉลี่ยต่อคน', 'violet');
                cards += createCard('-', 'หมายเหตุ', 'amber');
            } else if (subView === 'assist-overtime') {
                const currentData = getOvertimeDataForYear(assistGroupCalcYear);
                const hourlyRate = currentData.salary / 210;
                total = currentData.items.reduce((s, i) => s + (i.instances * i.days * i.hours * i.people * (i.rate === undefined ? hourlyRate : i.rate)), 0);
                count = currentData.items.reduce((s, i) => s + i.instances, 0);
                cards += createCard(count, 'จำนวนครั้งที่เกิด', 'indigo');
                cards += createCard(formatCurrency(total), 'ยอดรวมทั้งหมด', 'green');
                cards += createCard(currentData.items.reduce((s, i) => s + i.people, 0), 'จำนวนคน (รวม)', 'violet');
                cards += createCard(formatCurrency(hourlyRate), 'อัตรา/ชม. (ฐาน)', 'amber');
            }
            container.innerHTML = cards;
        }

        // --- SUMMARY FUNCTIONS ---
        function renderSummaryPage() {
            document.getElementById('display-summary-year').textContent = summaryCalcYear;
            
            // Re-run all necessary calculations for the summaryCalcYear
            // This ensures that the global `calculated...Data` arrays are up-to-date
            // for the year currently selected in the summary view.
            travelCalcYear = summaryCalcYear;
            familyVisitCalcYear = summaryCalcYear;
            managerRotationCalcYear = summaryCalcYear;
            assistGroupCalcYear = summaryCalcYear; // Ensure this is also aligned for assistance summaries

            calculateAndRenderTravelSouvenir();
            calculateAndRenderFamilyVisit();
            calculateAndRenderCompanyTrip(); // This updates calculatedCompanyTripTotalValue
            calculateAndRenderManagerRotation();
            calculateAndRenderSpecialAssist();
            calculateAndRenderSpecialAssist1();
            calculateAndRenderOvertime();

            calculateAndRenderOperationalSummary();
            calculateAndRenderTravelSummary();
            calculateAndRenderAssistanceSummary();
        }

        function calculateAndRenderOperationalSummary() {
            const container = document.getElementById('operational-summary-content');
            let totalOperational = 0;
            let contentHtml = '';

            const operationalCategories = [
                { name: 'หมวด 1 : ค่าใช้จ่ายเกี่ยวกับพนักงาน', startType: 'header', endType: 'header', startIndex: -1, endIndex: -1 },
                { name: 'หมวด 2 : ค่าใช้จ่ายดำเนินงานทั่วไป', startType: 'header', endType: 'header', startIndex: -1, endIndex: -1 }
            ];

            // Find start and end indices for each category
            for (let i = 0; i < budgetData.length; i++) {
                if (budgetData[i].type === 'header') {
                    for (let j = 0; j < operationalCategories.length; j++) {
                        if (budgetData[i].name === operationalCategories[j].name) {
                            operationalCategories[j].startIndex = i;
                            // Find the end index (next header or end of data)
                            for (let k = i + 1; k < budgetData.length; k++) {
                                if (budgetData[k].type === 'main_header' || budgetData[k].type === 'header') {
                                    operationalCategories[j].endIndex = k - 1;
                                    break;
                                }
                                if (k === budgetData.length - 1) { // End of data
                                    operationalCategories[j].endIndex = k;
                                }
                            }
                            break;
                        }
                    }
                }
            }

            operationalCategories.forEach(category => {
                let categoryTotal = 0;
                if (category.startIndex !== -1 && category.endIndex !== -1) {
                    for (let i = category.startIndex + 1; i <= category.endIndex; i++) {
                        const item = budgetData[i];
                        if (item.code && item.values && item.values[summaryCalcYear]) {
                            categoryTotal += item.values[summaryCalcYear];
                        }
                    }
                }
                totalOperational += categoryTotal;
                contentHtml += `<div class="flex justify-between items-center text-sm">
                                    <span>${category.name}:</span>
                                    <span class="font-semibold">${formatCurrency(categoryTotal)} บาท</span>
                                </div>`;
            });

            document.getElementById('operational-summary-content').innerHTML = contentHtml;
            document.getElementById('operational-grand-total').textContent = formatCurrency(totalOperational) + ' บาท';
        }


        function calculateAndRenderTravelSummary() {
            const container = document.getElementById('travel-summary-content');
            let totalTravel = 0;
            let contentHtml = '';

            // Use the already calculated global values
            const souvenirTotal = calculatedTravelEmployees.reduce((s, e) => s + e.total, 0);
            const familyVisitTotal = calculatedFamilyVisitData.reduce((s, e) => s + e.total, 0);
            const managerRotationTotal = calculatedManagerRotationData.reduce((s, e) => s + e.total, 0);
            // Use the globally stored calculatedCompanyTripTotalValue
            const currentCompanyTripTotal = calculatedCompanyTripTotalValue;

            totalTravel = souvenirTotal + familyVisitTotal + currentCompanyTripTotal + managerRotationTotal;

            contentHtml += `<div class="flex justify-between items-center text-sm">
                                <span>ค่าใช้จ่ายเดินทางเพื่อรับของที่ระลึก:</span>
                                <span class="font-semibold">${formatCurrency(souvenirTotal)} บาท</span>
                            </div>`;
            contentHtml += `<div class="flex justify-between items-center text-sm">
                                <span>ค่าเดินทางเยี่ยมครอบครัว:</span>
                                <span class="font-semibold">${formatCurrency(familyVisitTotal)} บาท</span>
                            </div>`;
            contentHtml += `<div class="flex justify-between items-center text-sm">
                                <span>ค่าเดินทางร่วมงานวันพนักงาน:</span>
                                <span class="font-semibold">${formatCurrency(currentCompanyTripTotal)} บาท</span>
                            </div>`;
            contentHtml += `<div class="flex justify-between items-center text-sm">
                                <span>ค่าเดินทางหมุนเวียนงาน ผจศ.:</span>
                                <span class="font-semibold">${formatCurrency(managerRotationTotal)} บาท</span>
                            </div>`;

            document.getElementById('travel-summary-content').innerHTML = contentHtml;
            document.getElementById('travel-grand-total').textContent = formatCurrency(totalTravel) + ' บาท';
        }

        function calculateAndRenderAssistanceSummary() {
            const container = document.getElementById('assistance-summary-content');
            let totalAssistance = 0;
            let contentHtml = '';

            // Use the already calculated global values
            const otherAssistTotal = calculatedSpecialAssistData.reduce((s, i) => s + i.total, 0);
            const specialAssist1Total = getSpecialAssist1DataForYear(summaryCalcYear).items.reduce((s, i) => s + (i.timesPerYear * i.days * i.people * i.rate), 0);
            const overtimeData = getOvertimeDataForYear(summaryCalcYear);
            const overtimeHourlyRate = overtimeData.salary / 210;
            const overtimeTotal = overtimeData.items.reduce((s, i) => s + (i.instances * i.days * i.hours * i.people * (i.rate === undefined ? overtimeHourlyRate : i.rate)), 0);

            totalAssistance = otherAssistTotal + specialAssist1Total + overtimeTotal;

            contentHtml += `<div class="flex justify-between items-center text-sm">
                                <span>เงินช่วยเหลืออื่นๆ:</span>
                                <span class="font-semibold">${formatCurrency(otherAssistTotal)} บาท</span>
                            </div>`;
            contentHtml += `<div class="flex justify-between items-center text-sm">
                                <span>เงินช่วยเหลือพิเศษ:</span>
                                <span class="font-semibold">${formatCurrency(specialAssist1Total)} บาท</span>
                            </div>`;
            contentHtml += `<div class="flex justify-between items-center text-sm">
                                <span>ค่าล่วงเวลาวันหยุด:</span>
                                <span class="font-semibold">${formatCurrency(overtimeTotal)} บาท</span>
                            </div>`;

            document.getElementById('assistance-summary-content').innerHTML = contentHtml;
            document.getElementById('assistance-grand-total').textContent = formatCurrency(totalAssistance) + ' บาท';
        }


        // --- EXPORT/IMPORT FUNCTIONS ---
        // Exports the budget data to an Excel file.
        function exportToExcel() { const cY = document.getElementById('select-year-current').value, nY = document.getElementById('select-year-next').value; const dataRows = budgetData.filter(i => i.code).map(i => { const cV = i.values[cY] || 0, nV = i.values[nY] || 0; return [i.code, i.name, cV, nV, nV - cV, i.notes]; }); const tC = dataRows.reduce((s, r) => s + r[2], 0), tN = dataRows.reduce((s, r) => s + r[3], 0); const tR = ['', 'ยอดรวมทั้งหมด', tC, tN, tN - tC, '']; const h = ['รหัสบัญชี', 'รายการ', `งบประมาณปี ${cY}`, `คำขอ งบประมาณปี ${nY}`, 'ผลต่าง (+/-)', 'หมายเหตุ']; const ws = XLSX.utils.aoa_to_sheet([h, ...dataRows, tR]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'งบประมาณ'); XLSX.writeFile(wb, `งบประมาณ_${cY}_vs_${nY}.xlsx`); }
        // Exports employee configuration data to an Excel file.
        function exportConfigToExcel() { const h = { id: 'รหัสพนักงาน', name: 'ชื่อ-สกุล', status: 'สถานะ', gender: 'เพศ', startYear: 'ปี พ.ศ. เริ่มงาน', level: 'ระดับ', visitProvince: 'จังหวัดเยี่ยมบ้าน', homeVisitBusFare: 'ค่ารถทัวร์เยี่ยมบ้าน' }; const d = employeeMasterData.map(e => { let r = {}; for (const k in h) { r[h[k]] = e[k]; } return r; }); const ws = XLSX.utils.json_to_sheet(d); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'ข้อมูลพนักงาน'); XLSX.writeFile(wb, 'ข้อมูลพนักงาน.xlsx'); }
        // Imports employee configuration data from an Excel file.
        function importConfigFromExcel(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(worksheet); const hM = { 'รหัสพนักงาน': 'id', 'ชื่อ-สกุล': 'name', 'สถานะ': 'status', 'เพศ': 'gender', 'ปี พ.ศ. เริ่มงาน': 'startYear', 'ระดับ': 'level', 'จังหวัดเยี่ยมบ้าน': 'visitProvince', 'ค่ารถทัวร์เยี่ยมบ้าน': 'homeVisitBusFare' }; const importedData = jsonData.map(row => { let nE = {}; for (const tH in hM) { const jK = hM[tH]; nE[jK] = row[tH] !== undefined ? row[tH] : ''; } return nE; }); employeeMasterData = importedData; renderEmployeeListTable(); saveDataToLocalStorage(); showAlert('สำเร็จ', `นำเข้าข้อมูล ${importedData.length} รายการเรียบร้อยแล้ว`); } catch (err) { console.error(err); showAlert('ผิดพลาด', 'ไม่สามารถอ่านไฟล์ Excel'); } event.target.value = ''; }; reader.readAsArrayBuffer(file); }
        
        // Populates the year selectors for current and next budget years.
        function populateYearSelectors() { const sC = document.getElementById('select-year-current'), sN = document.getElementById('select-year-next'); sC.innerHTML = ''; sN.innerHTML = ''; for (let y = 2568; y <= 2580; y++) { sC.innerHTML += `<option value="${y}">${y}</option>`; sN.innerHTML += `<option value="${y}">${y}</option>`; } sC.value = 2568; sN.value = 2569; }

        // --- NAVIGATION & EVENT LISTENERS ---
        // Global state to keep track of active travel tab
        let activeTravelTab = 'sub-view-travel-souvenir-content'; // Default active tab

        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            populateYearSelectors();
            
            const initialNextYear = parseInt(document.getElementById('select-year-next').value);
            travelCalcYear = initialNextYear;
            familyVisitCalcYear = initialNextYear;
            managerRotationCalcYear = initialNextYear;
            assistGroupCalcYear = initialNextYear;
            workdayCalcYear = initialNextYear;
            summaryCalcYear = initialNextYear; // Initialize summary year

            const mainViews = {
                budget: document.getElementById('view-budget'),
                config: document.getElementById('view-config'),
                travel: document.getElementById('view-travel'),
                assistance: document.getElementById('view-assistance'),
                workday: document.getElementById('view-workday'),
                summary: document.getElementById('view-summary') // Add new summary view
            };
            const navButtons = {
                budget: document.getElementById('nav-budget'),
                config: document.getElementById('nav-config'),
                travel: document.getElementById('nav-travel'),
                assistance: document.getElementById('nav-assistance'),
                workday: document.getElementById('nav-workday'),
                summary: document.getElementById('nav-summary') // Add new summary nav button
            };

            // Function to switch between main views
            function switchView(activeKey) {
                Object.values(mainViews).forEach(v => v.classList.add('hidden'));
                Object.values(navButtons).forEach(b => b.classList.remove('active'));
                
                mainViews[activeKey].classList.remove('hidden');
                navButtons[activeKey].classList.add('active');

                // Render specific content based on the active view
                if (activeKey === 'budget') renderBudgetTable();
                else if (activeKey === 'config') { renderMasterRatesTable(); renderEmployeeListTable(); }
                else if (activeKey === 'travel') renderTravelGroup();
                else if (activeKey === 'assistance') renderAssistanceGroup();
                else if (activeKey === 'workday') calculateWorkDays();
                else if (activeKey === 'summary') renderSummaryPage(); // Render summary page
            }

            // Add event listeners to main navigation buttons
            Object.keys(navButtons).forEach(key => navButtons[key].addEventListener('click', () => switchView(key)));
            
            // Sub-navigation for Assistance section
            const subViews = { 'assist-other': document.getElementById('sub-view-assist-other'), 'assist-special': document.getElementById('sub-view-assist-special'), 'assist-overtime': document.getElementById('sub-view-assist-overtime') };
            const subNavButtons = { 'assist-other': document.getElementById('sub-nav-assist-other'), 'assist-special': document.getElementById('sub-nav-assist-special'), 'assist-overtime': document.getElementById('sub-nav-assist-overtime') };
            
            // Function to switch between sub-views within a group (e.g., Assistance)
            window.switchSubView = (group, activeKey) => {
                if (group === 'assistance') {
                    Object.values(subViews).forEach(v => v.classList.add('hidden'));
                    Object.values(subNavButtons).forEach(b => b.classList.remove('active'));
                    subViews[activeKey].classList.remove('hidden');
                    subNavButtons[activeKey].classList.add('active');
                    renderKpiCards(activeKey); // Render KPI cards relevant to the active sub-view
                }
            }
            // Add event listeners to sub-navigation buttons
            Object.keys(subNavButtons).forEach(key => subNavButtons[key].addEventListener('click', () => switchSubView('assistance', key)));

            // New sub-views and sub-nav buttons for Travel
            const travelSubViews = {
                'sub-view-travel-souvenir-content': document.getElementById('sub-view-travel-souvenir-content'),
                'sub-view-travel-family-content': document.getElementById('sub-view-travel-family-content'),
                'sub-view-travel-company-content': document.getElementById('sub-view-travel-company-content'),
                'sub-view-travel-manager-content': document.getElementById('sub-view-travel-manager-content')
            };
            const travelSubNavButtons = {
                'sub-nav-travel-souvenir-tab': document.getElementById('sub-nav-travel-souvenir-tab'),
                'sub-nav-travel-family-tab': document.getElementById('sub-nav-travel-family-tab'),
                'sub-nav-travel-company-tab': document.getElementById('sub-nav-travel-company-tab'),
                'sub-nav-travel-manager-tab': document.getElementById('sub-nav-travel-manager-tab')
            };

            window.switchTravelSubView = (activeKey) => {
                Object.values(travelSubViews).forEach(v => v.classList.add('hidden'));
                Object.values(travelSubNavButtons).forEach(b => b.classList.remove('active'));

                travelSubViews[activeKey].classList.remove('hidden');
                // Find the button that targets this content
                const activeBtn = Object.values(travelSubNavButtons).find(btn => btn.dataset.target === activeKey);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                activeTravelTab = activeKey; // Update global state

                // Re-render the content of the active tab
                if (activeKey === 'sub-view-travel-souvenir-content') calculateAndRenderTravelSouvenir();
                else if (activeKey === 'sub-view-travel-family-content') calculateAndRenderFamilyVisit();
                else if (activeKey === 'sub-view-travel-company-content') calculateAndRenderCompanyTrip();
                else if (activeKey === 'sub-view-travel-manager-content') calculateAndRenderManagerRotation();
            };

            // Add event listeners for travel sub-navigation buttons
            Object.keys(travelSubNavButtons).forEach(key => {
                travelSubNavButtons[key].addEventListener('click', (event) => {
                    const targetId = event.target.dataset.target || event.target.closest('button').dataset.target;
                    switchTravelSubView(targetId);
                });
            });


            // Modal listeners
            document.getElementById('alert-close-button').addEventListener('click', () => hideModal(alertModal));
            document.getElementById('confirm-cancel-button').addEventListener('click', () => { hideModal(confirmModal); confirmCallback = null; });
            document.getElementById('confirm-ok-button').addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideModal(confirmModal); confirmCallback = null; });

            // Year selectors and other controls
            const selectYearCurrent = document.getElementById('select-year-current');
            const selectYearNext = document.getElementById('select-year-next');
            
            // Handles year change in selectors and updates all relevant views.
            const handleYearChange = () => {
                const newYear = parseInt(selectYearNext.value);
                travelCalcYear = newYear;
                familyVisitCalcYear = newYear;
                managerRotationCalcYear = newYear;
                assistGroupCalcYear = newYear;
                workdayCalcYear = newYear;
                summaryCalcYear = newYear; // Update summary year as well
                
                // Re-render the currently active view to reflect the new year
                const activeView = document.querySelector('.main-view:not(.hidden)');
                if (activeView) {
                    const activeId = activeView.id.replace('view-', '');
                    switchView(activeId);
                }
            }
            selectYearCurrent.addEventListener('change', handleYearChange);
            selectYearNext.addEventListener('change', handleYearChange);
            
            // Budget year navigation buttons
            const budgetPrevBtn = document.getElementById('budget-prev-year-btn');
            const budgetNextBtn = document.getElementById('budget-next-year-btn');
            budgetPrevBtn.addEventListener('click', () => {
                selectYearCurrent.selectedIndex = Math.max(0, selectYearCurrent.selectedIndex - 1);
                selectYearNext.selectedIndex = Math.max(0, selectYearNext.selectedIndex - 1);
                handleYearChange();
            });
             budgetNextBtn.addEventListener('click', () => {
                selectYearCurrent.selectedIndex = Math.min(selectYearCurrent.options.length - 1, selectYearCurrent.selectedIndex + 1);
                selectYearNext.selectedIndex = Math.min(selectYearNext.options.length - 1, selectYearNext.selectedIndex + 1);
                handleYearChange();
            });

            // Global action buttons
            document.getElementById('reset-data-btn').addEventListener('click', resetAllData);
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('import-config-btn').addEventListener('click', () => document.getElementById('import-config-input').click());
            document.getElementById('import-config-input').addEventListener('change', importConfigFromExcel);
            document.getElementById('print-budget-btn').addEventListener('click', () => window.print());
            
            // Year navigation listeners for other sections (Travel, Workday, Assistance Group, Summary)
            const setupYearNav = (type, calcVarSetter, renderFunc) => {
                const prevBtn = document.getElementById(`prev-${type}-year-btn`);
                const nextBtn = document.getElementById(`next-${type}-year-btn`);
                if (prevBtn) { // Check if element exists before adding listener
                    prevBtn.addEventListener('click', () => { calcVarSetter(eval(type+'CalcYear') - 1); renderFunc(); });
                }
                if (nextBtn) { // Check if element exists before adding listener
                    nextBtn.addEventListener('click', () => { calcVarSetter(eval(type+'CalcYear') + 1); renderFunc(); });
                }
            };
            // Re-define setupYearNav for travel to specifically call switchTravelSubView
            setupYearNav('travel', (y) => {travelCalcYear=y;}, () => { switchTravelSubView(activeTravelTab); }); // No direct renderFunc needed here, switchTravelSubView will handle it.

            // Removed redundant setupYearNav calls for family-visit and manager-rotation
            // setupYearNav('family-visit', (y) => {familyVisitCalcYear=y;}, calculateAndRenderFamilyVisit);
            // setupYearNav('manager-rotation', (y) => {managerRotationCalcYear=y;}, calculateAndRenderManagerRotation);

            setupYearNav('workday', (y) => {workdayCalcYear=y;}, calculateWorkDays);
            document.getElementById('prev-assist-group-year-btn').addEventListener('click', () => { assistGroupCalcYear--; renderAssistanceGroup(document.querySelector('.sub-nav-button.active').id.replace('sub-nav-','')); });
            document.getElementById('next-assist-group-year-btn').addEventListener('click', () => { assistGroupCalcYear++; renderAssistanceGroup(document.querySelector('.sub-nav-button.active').id.replace('sub-nav-','')); });
            setupYearNav('summary', (y) => {summaryCalcYear=y;}, renderSummaryPage); // New year navigation for summary

            // Event listener for adding new holidays
            document.getElementById('add-holiday-btn').addEventListener('click', () => { if(workdayCalcYear) addHoliday(workdayCalcYear - 543); });
            
            // Function to apply calculated totals to the budget table
            function applyTotalToBudget(total, budgetCode, successMessage, errorMessage, targetYear) {
                const itemIndex = budgetData.findIndex(item => item.code === budgetCode);
                if (itemIndex !== -1) {
                    budgetData[itemIndex].values[targetYear] = total;
                    saveDataToLocalStorage();
                    showAlert("สำเร็จ", `ยอดรวม ${formatCurrency(total)} บาท ${successMessage} สำหรับปี ${targetYear}`);
                    switchView("budget"); // Switch to budget view after applying
                } else { showAlert("เกิดข้อผิดพลาด", errorMessage); }
            }

            // Event listeners for "Apply Total to Budget" buttons
            document.getElementById('apply-travel-total-btn').addEventListener('click', () => { const total = calculatedTravelEmployees.reduce((s, e) => s + e.total, 0); if (total === 0 && calculatedTravelEmployees.length === 0) return showAlert("ข้อมูลไม่พร้อม", "ไม่พบพนักงานที่เข้าเกณฑ์"); applyTotalToBudget(total, '53100200', "ถูกตั้งงบใน 'ค่าใช้จ่ายในการเดินทาง'", "ไม่พบรายการ 'ค่าใช้จ่ายในการเดินทาง'", travelCalcYear); });
            document.getElementById('apply-special-assist-total-btn').addEventListener('click', () => { const total = calculatedSpecialAssistData.reduce((s, i) => s + i.total, 0); applyTotalToBudget(total, '55080400', "ถูกตั้งงบใน 'เงินช่วยเหลืออื่นๆ'", "ไม่พบรายการ 'เงินช่วยเหลืออื่นๆ'", assistGroupCalcYear); });
            document.getElementById('apply-family-visit-total-btn').addEventListener('click', () => { const total = calculatedFamilyVisitData.reduce((s, e) => s + e.total, 0); applyTotalToBudget(total, '53100201', "ถูกตั้งงบใน 'ค่าเดินทางเยี่ยมครอบครัว'", "ไม่พบรายการ 'ค่าเดินทางเยี่ยมครอบครัว'", familyVisitCalcYear); });
            document.getElementById('apply-manager-rotation-total-btn').addEventListener('click', () => { const total = calculatedManagerRotationData.reduce((s, e) => s + e.total, 0); applyTotalToBudget(total, '53100202', "ถูกตั้งงบใน 'ค่าเดินทางหมุนเวียนงาน ผจศ.'", "ไม่พบรายการ 'ค่าเดินทางหมุนเวียนงาน ผจศ.'", managerRotationCalcYear); });
            document.getElementById('apply-overtime-total-btn').addEventListener('click', () => { const d = getOvertimeDataForYear(assistGroupCalcYear); const hR = d.salary / 210; const total = d.items.reduce((s, i) => s + (i.instances * i.days * i.hours * i.people * (i.rate === undefined ? hR : i.rate)), 0); applyTotalToBudget(total, '52010700', "ถูกตั้งงบใน 'ค่าล่วงเวลา'", "ไม่พบรายการ 'ค่าล่วงเวลา'", assistGroupCalcYear); });

            // Initial render: show the budget view by default
            switchView('budget');
        });
    </script>

</body>
</html>
